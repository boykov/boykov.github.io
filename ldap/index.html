<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="ru" xml:lang="ru">
<head>
<!-- 2017-02-09 Чт. 17:19 -->
<meta  http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta  name="viewport" content="width=device-width, initial-scale=1" />
<title>Аутентификация пользователей CentOS 5/6 с использованием OpenLDAP 2.3/2.4</title>
<meta  name="generator" content="Org-mode" />
<style type="text/css">
 <!--/*--><![CDATA[/*><!--*/
  .title  { text-align: center;
             margin-bottom: .2em; }
  .subtitle { text-align: center;
              font-size: medium;
              font-weight: bold;
              margin-top:0; }
  .todo   { font-family: monospace; color: red; }
  .done   { font-family: monospace; color: green; }
  .priority { font-family: monospace; color: orange; }
  .tag    { background-color: #eee; font-family: monospace;
            padding: 2px; font-size: 80%; font-weight: normal; }
  .timestamp { color: #bebebe; }
  .timestamp-kwd { color: #5f9ea0; }
  .org-right  { margin-left: auto; margin-right: 0px;  text-align: right; }
  .org-left   { margin-left: 0px;  margin-right: auto; text-align: left; }
  .org-center { margin-left: auto; margin-right: auto; text-align: center; }
  .underline { text-decoration: underline; }
  #postamble p, #preamble p { font-size: 90%; margin: .2em; }
  p.verse { margin-left: 3%; }
  pre {
    border: 1px solid #ccc;
    box-shadow: 3px 3px 3px #eee;
    padding: 8pt;
    font-family: monospace;
    overflow: auto;
    margin: 1.2em;
  }
  pre.src {
    position: relative;
    overflow: visible;
    padding-top: 1.2em;
  }
  pre.src:before {
    display: none;
    position: absolute;
    background-color: white;
    top: -10px;
    right: 10px;
    padding: 3px;
    border: 1px solid black;
  }
  pre.src:hover:before { display: inline;}
  pre.src-sh:before    { content: 'sh'; }
  pre.src-bash:before  { content: 'sh'; }
  pre.src-emacs-lisp:before { content: 'Emacs Lisp'; }
  pre.src-R:before     { content: 'R'; }
  pre.src-perl:before  { content: 'Perl'; }
  pre.src-java:before  { content: 'Java'; }
  pre.src-sql:before   { content: 'SQL'; }

  table { border-collapse:collapse; }
  caption.t-above { caption-side: top; }
  caption.t-bottom { caption-side: bottom; }
  td, th { vertical-align:top;  }
  th.org-right  { text-align: center;  }
  th.org-left   { text-align: center;   }
  th.org-center { text-align: center; }
  td.org-right  { text-align: right;  }
  td.org-left   { text-align: left;   }
  td.org-center { text-align: center; }
  dt { font-weight: bold; }
  .footpara { display: inline; }
  .footdef  { margin-bottom: 1em; }
  .figure { padding: 1em; }
  .figure p { text-align: center; }
  .inlinetask {
    padding: 10px;
    border: 2px solid gray;
    margin: 10px;
    background: #ffffcc;
  }
  #org-div-home-and-up
   { text-align: right; font-size: 70%; white-space: nowrap; }
  textarea { overflow-x: auto; }
  .linenr { font-size: smaller }
  .code-highlighted { background-color: #ffff00; }
  .org-info-js_info-navigation { border-style: none; }
  #org-info-js_console-label
    { font-size: 10px; font-weight: bold; white-space: nowrap; }
  .org-info-js_search-highlight
    { background-color: #ffff00; color: #000000; font-weight: bold; }
  /*]]>*/-->
</style>
<link rel="stylesheet" type="text/css" href="../org-html-themes/styles/readtheorg/css/htmlize.css"/>
<link rel="stylesheet" type="text/css" href="../org-html-themes/styles/readtheorg/css/readtheorg.css"/>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/js/bootstrap.min.js"></script>
<script type="text/javascript" src="../org-html-themes/styles/lib/js/jquery.stickytableheaders.min.js"></script>
<script type="text/javascript" src="../org-html-themes/styles/readtheorg/js/readtheorg.js"></script>
<style type="text/css">.org-src-name{ text-align: right; }</style>
<style type="text/css">.outline-2{ margin-top: 60px; }</style>

<style type="text/css">
  pre.src:before {
    top: -5px;
  }
</style>
<script type="text/javascript">
/*
@licstart  The following is the entire license notice for the
JavaScript code in this tag.

Copyright (C) 2012-2013 Free Software Foundation, Inc.

The JavaScript code in this tag is free software: you can
redistribute it and/or modify it under the terms of the GNU
General Public License (GNU GPL) as published by the Free Software
Foundation, either version 3 of the License, or (at your option)
any later version.  The code is distributed WITHOUT ANY WARRANTY;
without even the implied warranty of MERCHANTABILITY or FITNESS
FOR A PARTICULAR PURPOSE.  See the GNU GPL for more details.

As additional permission under GNU GPL version 3 section 7, you
may distribute non-source (e.g., minimized or compacted) forms of
that code without the copy of the GNU GPL normally required by
section 4, provided you include this license notice and a URL
through which recipients can access the Corresponding Source.


@licend  The above is the entire license notice
for the JavaScript code in this tag.
*/
<!--/*--><![CDATA[/*><!--*/
 function CodeHighlightOn(elem, id)
 {
   var target = document.getElementById(id);
   if(null != target) {
     elem.cacheClassElem = elem.className;
     elem.cacheClassTarget = target.className;
     target.className = "code-highlighted";
     elem.className   = "code-highlighted";
   }
 }
 function CodeHighlightOff(elem, id)
 {
   var target = document.getElementById(id);
   if(elem.cacheClassElem)
     elem.className = elem.cacheClassElem;
   if(elem.cacheClassTarget)
     target.className = elem.cacheClassTarget;
 }
/*]]>*///-->
</script>
</head>
<body>
<div id="content">
<h1 class="title">Аутентификация пользователей CentOS 5/6 с использованием OpenLDAP 2.3/2.4</h1>
<div id="table-of-contents">
<h2>&#1057;&#1086;&#1076;&#1077;&#1088;&#1078;&#1072;&#1085;&#1080;&#1077;</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#intro">Введение</a></li>
<li><a href="#install-and-config">1. Установка и настройка сервера OpenLDAP</a>
<ul>
<li><a href="#install-openldap">1.1. Установка OpenLDAP</a></li>
<li><a href="#configure-hdb">1.2. Добавление файлов конфигурации базы данных HDB</a></li>
<li><a href="#add-schemas">1.3. Добавление файлов наборов схем данных</a></li>
<li><a href="#choose-setup">1.4. Выбор варианта настройки схемы каталога LDAP</a></li>
<li><a href="#configure-slapd-conf">1.5. Предварительная настройка схемы каталога LDAP</a></li>
<li><a href="#configure-slapd">1.6. Дополнительно. Предварительная настройка схемы каталога LDAP с помощью ldif формата</a></li>
</ul>
</li>
<li><a href="#authentication">2. Настройка аутентификации пользователей при помощи LDAP</a>
<ul>
<li><a href="#client-packages">2.1. Требуемые пакеты</a></li>
<li><a href="#client-commands">2.2. Используемые команды</a></li>
<li><a href="#client-files">2.3. Изменяемые файлы</a></li>
<li><a href="#client-options">2.4. Описание опций</a>
<ul>
<li><a href="#orgheadline12">2.4.1. Опции, связанные с conf-файлами для <b>5/2.3</b></a></li>
<li><a href="#orgheadline13">2.4.2. Опции, связанные с файлом system-auth для <b>5/2.3</b></a></li>
<li><a href="#orgheadline14">2.4.3. Опции, связанные с conf-файлами для <b>6/2.4</b></a></li>
<li><a href="#orgheadline15">2.4.4. Опции, связанные с файлом system-auth для <b>6/2.4</b></a></li>
<li><a href="#orgheadline16">2.4.5. Дополнительно. PAM: необходимые сведения</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#schema">3. Схема каталога LDAP</a>
<ul>
<li><a href="#minimal-schema">3.1. Настройка каталога LDAP</a></li>
<li><a href="#hdb-domain-config">3.2. Связывание базы данных HDB с доменом и настройка ACL</a></li>
<li><a href="#root-domain">3.3. Создание корневой записи домена</a></li>
<li><a href="#create-sudoers">3.4. Формирование подразделения sudoers</a></li>
<li><a href="#ldap-possibilities">3.5. Дополнительно. Возможности LDAP</a></li>
</ul>
</li>
<li><a href="#new-user">4. Процесс добавления нового пользователя в систему</a>
<ul>
<li><a href="#new-user-ldap">4.1. Добавление пользователя с помощью CLI интерфейса</a></li>
<li><a href="#new-user-php">4.2. Добавление пользователя с помощью GUI Web интерфейса</a></li>
<li><a href="#test-client">4.3. Тестирование клиентского подключения</a></li>
<li><a href="#standard-commands">4.4. Стандартные команды администрирования пользователей в случае использования LDAP</a></li>
<li><a href="#add-users">4.5. Миграция пользователей и групп</a></li>
</ul>
</li>
<li><a href="#cluster">5. Перевести аутентификацию пользователей кластера на использование LDAP</a></li>
</ul>
</div>
</div>

<div id="outline-container-orgheadline1" class="outline-2">
<h2 id="intro"><a id="orgheadline1"></a><a id="ID-be7bb1b4-d8e8-4b5f-8aa3-754d148fa6ba"></a>Введение</h2>
<div class="outline-text-2" id="text-intro">
<p>
В процессе написания использовались материалы:
</p>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">English version</th>
<th scope="col" class="org-left">Русская версия</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left"><a href="http://www.openldap.org/doc/admin24/">OpenLDAP Software 2.4 Administrator's Guide</a></td>
<td class="org-left"><a href="http://pro-ldap.ru/tr/admin24/index.html">Руководство администратора OpenLDAP 2.4</a></td>
</tr>

<tr>
<td class="org-left"><a href="http://www.openldap.org/doc/admin23/">OpenLDAP Software 2.3 Administrator's Guide</a></td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left"><a href="http://www.zytrax.com/books/ldap/">LDAP for Rocket Scientists</a></td>
<td class="org-left"><a href="http://pro-ldap.ru/tr/zytrax/">LDAP для ученых-ракетчиков</a></td>
</tr>

<tr>
<td class="org-left"><a href="http://itdavid.blogspot.ru/2012/05/howto-centos-6.html">HOWTO : CentOS 6.2 OpenLDAP 2.4 Setup </a></td>
<td class="org-left"><a href="http://pro-ldap.ru/books/openldap-ubuntu-in-practice/">OpenLDAP и Ubuntu на практике</a></td>
</tr>

<tr>
<td class="org-left"><a href="https://www.packtpub.com/networking-and-servers/mastering-openldap-configuring-securing-and-integrating-directory-services">Matt Butcher. <b>Mastering OpenLDAP: Configuring, Securing and Integrating Directory Services</b>. Packt Publishing, 2007.</a></td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left"><a href="http://shop.oreilly.com/product/9781565924918.do">Gerald Carter. LDAP system administration. O'Reilly Media, 2003.</a></td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left"><a href="http://www.linux-pam.org/Linux-PAM-html/Linux-PAM_SAG.html">The Linux-PAM System Administrators' Guide</a></td>
<td class="org-left">&#xa0;</td>
</tr>
</tbody>
</table>

<p>
Конфигурация используемых на нашем демо-стенде контейнеров:
</p>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">Роль</th>
<th scope="col" class="org-left">Имя хоста</th>
<th scope="col" class="org-left">ОС</th>
<th scope="col" class="org-left">Конфигурация хоста</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left"><b>Docker Engine</b></td>
<td class="org-left">kairos</td>
<td class="org-left"><b>Ubuntu 14.04</b></td>
<td class="org-left"><b>Docker 1.12.5</b></td>
</tr>
</tbody>
<tbody>
<tr>
<td class="org-left"><b>Служба каталогов</b></td>
<td class="org-left">server-ldif5</td>
<td class="org-left"><b>CentOS 5</b></td>
<td class="org-left"><b>OpenLDAP 2.3</b> server, <b>ldif</b>; <b>phpLDAPadmin 1.2.3</b>, custom</td>
</tr>

<tr>
<td class="org-left"><b>Служба каталогов</b></td>
<td class="org-left">server-ldif6</td>
<td class="org-left"><b>CentOS 6</b></td>
<td class="org-left"><b>OpenLDAP 2.4</b> server, <b>ldif</b>; <b>phpLDAPadmin 1.2.3</b>, custom</td>
</tr>

<tr>
<td class="org-left"><b>Служба каталогов</b></td>
<td class="org-left">server-conf5</td>
<td class="org-left"><b>CentOS 5</b></td>
<td class="org-left"><b>OpenLDAP 2.3</b> server, <b>conf</b>; <b>phpLDAPadmin 1.2.3</b>, custom</td>
</tr>

<tr>
<td class="org-left"><b>Служба каталогов</b></td>
<td class="org-left">server-conf6</td>
<td class="org-left"><b>CentOS 6</b></td>
<td class="org-left"><b>OpenLDAP 2.4</b> server, <b>conf</b>; <b>phpLDAPadmin 1.2.3</b>, custom</td>
</tr>

<tr>
<td class="org-left"><b>Клиент службы каталогов</b></td>
<td class="org-left">client5</td>
<td class="org-left"><b>CentOS 5</b></td>
<td class="org-left"><b>OpenLDAP 2.3</b> client</td>
</tr>

<tr>
<td class="org-left"><b>Клиент службы каталогов</b></td>
<td class="org-left">client6</td>
<td class="org-left"><b>CentOS 6</b></td>
<td class="org-left"><b>OpenLDAP 2.4</b> client</td>
</tr>

<tr>
<td class="org-left"><b>Клиент службы каталогов</b></td>
<td class="org-left">gui</td>
<td class="org-left"><b>Debian 8</b></td>
<td class="org-left"><b>phpLDAPadmin 1.2.3</b>, custom</td>
</tr>
</tbody>
</table>

<div class="note">
<p>
Команды и конфигурационные файлы прошли проверку на работоспособность
в тестовом программном окружении, доступном в проекте
cc-ldap-centos<sup><a id="fnr.1" class="footref" href="#fn.1">1</a></sup>.
</p>

</div>
</div>
</div>

<div id="outline-container-orgheadline8" class="outline-2">
<h2 id="install-and-config"><a id="orgheadline8"></a><a id="ID-f3a148ae-26f4-4c54-a25c-532d2b9086ba"></a><span class="section-number-2">1</span> Установка и настройка сервера OpenLDAP</h2>
<div class="outline-text-2" id="text-install-and-config">
<blockquote>
<p>
Необходимо разработать документацию по установке и настройке сервера LDAP в ОС <b>CentOS 5</b>. Предпочтение отдавать реализациям, доступным в базовом репозитории дистрибутива. Проверить работоспособность выработанных инструкций в ОС <b>CentOS 6</b>.
</p>
</blockquote>
</div>

<div id="outline-container-orgheadline2" class="outline-3">
<h3 id="install-openldap"><a id="orgheadline2"></a><a id="ID-cdb77a09-a1eb-4db8-ad05-e45c3b49418c"></a><span class="section-number-3">1.1</span> Установка OpenLDAP</h3>
<div class="outline-text-3" id="text-install-openldap">
<p class="verse">
Где работаем: контейнеры <b>server-&#x2026;..</b><br  />
</p>

<p>
Базовые репозитории дистрибутивов <b>CentOS 5</b> и <b>CentOS 6</b> содержат
<b>2.3</b> и <b>2.4</b> версию <b>OpenLDAP</b>, соответственно. Выполнив стандартную
установку
</p>

<div class="org-src-container">
<label class="org-src-name">Установка сервера <b>OpenLDAP</b> для <b>5/2.3</b> и <b>6/2.4</b></label>
<pre class="src src-org">    yum -y install openldap openldap-servers openldap-clients sudo
    yum -y install php php-ldap wget
</pre>
</div>

<div class="org-src-container">
<label class="org-src-name">Установка дополнительных пакетов для <b>5/2.3</b></label>
<pre class="src src-org">    yum -y install openldap-servers-overlays
    wget <span style="color: #b58900; text-decoration: underline;"><a href="http://dl.fedoraproject.org/pub/epel/5/i386/phpldapadmin-1.2.3-1.el5.noarch.rpm">http://dl.fedoraproject.org/pub/epel/5/i386/phpldapadmin-1.2.3-1.el5.noarch.rpm</a></span>
    rpm -i phpldapadmin-1.2.3-1.el5.noarch.rpm
</pre>
</div>

<div class="org-src-container">
<label class="org-src-name">Установка дополнительных пакетов для <b>6/2.4</b></label>
<pre class="src src-org">    wget <span style="color: #b58900; text-decoration: underline;"><a href="http://dl.fedoraproject.org/pub/epel/6/i386/phpldapadmin-1.2.3-2.el6.noarch.rpm">http://dl.fedoraproject.org/pub/epel/6/i386/phpldapadmin-1.2.3-2.el6.noarch.rpm</a></span>
    rpm -i phpldapadmin-1.2.3-2.el6.noarch.rpm
</pre>
</div>



<p>
получаем две конфигурации, различающиеся в некоторых
деталях. Например, название сервиса: <b>ldap</b> в случае <b>CentOS 5/2.3
OpenLDAP</b> (<b>5/2.3</b>) и <b>slapd</b> в случае <b>CentOS 6/2.4 OpenLDAP</b>
(<b>6/2.4</b>).
</p>
</div>
</div>

<div id="outline-container-orgheadline3" class="outline-3">
<h3 id="configure-hdb"><a id="orgheadline3"></a><a id="ID-af4bb15a-67f0-4e1a-8ce6-18c118ff10cd"></a><span class="section-number-3">1.2</span> Добавление файлов конфигурации базы данных HDB</h3>
<div class="outline-text-3" id="text-configure-hdb">
<p class="verse">
Где работаем: контейнеры <b>server-&#x2026;..</b><br  />
</p>

<p>
Для запуска сервиса <b>ldap</b> (<b>slapd</b>) необходимо подготовить директорию и
файл конфигурации базы данных. Расположение образца файла настройки, в
<b>5/2.3</b>
</p>
<div class="org-src-container">
<label class="org-src-name">Конфигурация БД для <b>5/2.3</b></label>
<pre class="src src-sh">    cp /etc/openldap/DB_CONFIG.example /var/lib/ldap/DB_CONFIG
    chown ldap. /var/lib/ldap/DB_CONFIG
</pre>
</div>
<p>
а в <b>6/2.4</b>
</p>
<div class="org-src-container">
<label class="org-src-name">Конфигурация БД для <b>6/2.4</b></label>
<pre class="src src-sh">    cp /usr/share/openldap-servers/DB_CONFIG.example /var/lib/ldap/DB_CONFIG
    chown ldap. /var/lib/ldap/DB_CONFIG
</pre>
</div>
<p>
Используем настройки без изменений в обеих конфигурациях. В подразделе
<a href="#hdb-domain-config">3.2</a> будет осуществлено связывание базы данных <b>HDB</b> и
точки ветвления дерева DIT, соответствующей домену
<b>dc=mercury,dc=febras,dc=net</b>.
</p>

<div class="tip">
<p>
В случае использования <b>OpenLDAP</b> версии <b>2.4</b> вместо базы данных
<b>HDB</b> в качестве бэкенда можно использовать отображаемую в памяти базу
данных <b>MDB</b>. Версия <b>2.3</b> не поддерживает <b>MDB</b>.
</p>

</div>
</div>
</div>

<div id="outline-container-orgheadline4" class="outline-3">
<h3 id="add-schemas"><a id="orgheadline4"></a><a id="ID-6638ce89-fc58-4610-aa0a-ab3ade7d3825"></a><span class="section-number-3">1.3</span> Добавление файлов наборов схем данных</h3>
<div class="outline-text-3" id="text-add-schemas">
<p class="verse">
Где работаем: контейнеры <b>server-&#x2026;..</b><br  />
</p>
<p>
Каталог LDAP имеет раздел <b>cn=schema</b>, содержащий все определения
системной схемы данных, которые вкомилированы в <b>ldap</b> (<b>slapd</b>). Сюда
же подключаются дополнительные специфические схемы данных,
см. расп. <a href="#orgsrcblock1">16</a>. Подготовим
необходимые файлы (не включенные в поставку <b>OpenLDAP</b>), для <b>5/2.3</b>
</p>
<div class="org-src-container">
<label class="org-src-name">Добавление файлов схем данных для <b>5/2.3</b></label>
<pre class="src src-sh">    cp /usr/share/doc/sudo-1.7.2p1/schema.OpenLDAP /etc/openldap/schema/sudo.schema
    chown ldap. /etc/openldap/schema/sudo.schema
</pre>
</div>
<p>
и для <b>6/2.4</b>
</p>
<div class="org-src-container">
<label class="org-src-name">Добавление файлов схем данных для <b>6/2.4</b></label>
<pre class="src src-sh">    cp /usr/share/doc/sudo-1.8.6p3/schema.OpenLDAP /etc/openldap/schema/sudo.schema
    chown ldap. /etc/openldap/schema/sudo.schema
</pre>
</div>

<p>
В подразделе <a href="#create-sudoers">3.4</a> для создания подразделения <b>sudoers</b>
используется класс из файла <b>sudo.schema</b>.
</p>
</div>
</div>

<div id="outline-container-orgheadline5" class="outline-3">
<h3 id="choose-setup"><a id="orgheadline5"></a><a id="ID-cb0ed9d0-14cc-4969-897d-a398e2f1ea65"></a><span class="section-number-3">1.4</span> Выбор варианта настройки схемы каталога LDAP</h3>
<div class="outline-text-3" id="text-choose-setup">
<p>
Конфигурация <b>6/2.4</b> поставляется с тремя вариантами базовых настроек,
осуществляемых через файлы <b>slapd.conf.obsolete</b>, <b>slapd.ldif.example</b>
и, доступной по умолчанию, предварительно сформированной директорией
<b>slapd.d</b>. При этом, настройка с помощью файла <b>slapd.ldif.example</b>
подразумевает использование утилиты <b>slapadd</b>, как это рекомендуется в
разделе "быстрый старт"
руководства<sup><a id="fnr.2" class="footref" href="#fn.2">2</a></sup>. Конфигурация
<b>5/2.3</b> по умолчанию настраивается только файлом <b>slapd.conf</b>,
предварительно сформированная директория <b>slapd.d</b> в формате <b>ldif</b>
отсутствует. Такой подход считается устаревшим,
рекомендуется<sup><a id="fnr.3" class="footref" href="#fn.3">3</a></sup>
использовать <b>ldif</b> формат и преобразовывать файл <b>slapd.conf</b>
настройки в директорию <b>slapd.d</b> с помощью утилиты <b>slaptest</b>.
</p>

<p>
Все варианты настроек разделяются на два существенно различающихся
способа. Первый способ включает в себя настройку с помощью <b>conf</b> файла
(конвертация через <b>slaptest</b>) и предварительно сформированную директорию
<b>slapd.d</b> (только для версии <b>2.4</b>). Эти два варианта являются
взаимозаменяемыми и формируют практически идентичные результирующие
файлы директории <b>slapd.d</b>. Второй способ заключается в использовании
файла <b>slapd.ldif</b> и утилиты <b>slapdd</b>. В этом случае, содержимое
файлов директории <b>slapd.d</b> существенно отличается, по сравнению с
первым способом. Дело в том, что при использовании первого способа в
файлах директории <b>slapd.d</b> присутствует большое количество
дополнительных параметров (явно не указанных в файле <b>slapd.conf</b>), а
при использовании второго &#x2014; только те, которые явно прописываются в
файле <b>slapd.ldif</b>.
</p>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">
<caption class="t-above"><span class="table-number">&#1058;&#1072;&#1073;&#1083;&#1080;&#1094;&#1072; 1.:</span> Поддержка способов настройки схемы каталога LDAP различными версиями <b>OpenLDAP</b></caption>

<colgroup>
<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">Способы настройки</th>
<th scope="col" class="org-left">поддержка <b>ldif</b></th>
<th scope="col" class="org-left"><b>2.3</b></th>
<th scope="col" class="org-left"><b>2.4</b></th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">Настройка с помощью файла <b>slapd.conf</b></td>
<td class="org-left">конвертация <b>slaptest</b></td>
<td class="org-left">да</td>
<td class="org-left">да</td>
</tr>

<tr>
<td class="org-left">Настройка с помощью файла <b>slapd.ldif</b></td>
<td class="org-left">да</td>
<td class="org-left">особо</td>
<td class="org-left">особо</td>
</tr>

<tr>
<td class="org-left">Предварительно сформированная директория <b>slapd.d</b></td>
<td class="org-left">да</td>
<td class="org-left">нет</td>
<td class="org-left">да</td>
</tr>
</tbody>
</table>

<p>
Какой вариант настройки выбрать? Если требуется наличие тех
дополнительных параметров, которые разработчики посчитали нужным
включить в настройки по умолчанию, то выбирается первый способ
настройки &#x2014; основной. При этом, если выбирается
<b>OpenLDAP 2.3</b>, то используются файл <b>slapd.conf</b> и утилита <b>slaptest</b>. А
если версия <b>2.4</b>, то можно в качестве равноценной альтернативы воспользоваться
предварительно сформированной директорией <b>slapd.d</b>.
</p>

<div class="note">
<p>
Первичный доступ к каталогу LDAP, использующему только предварительно
сформированную директорию <b>slapd.d</b> без <b>conf</b>-файла, осуществляется
при помощи <b>ldapi</b> интерфейса, когда в качестве <b>rootdn</b> выступает
системный пользователь <b>root</b> (при этом его <b>dn</b> выглядит как
<b>gidNumber=0+uidNumber=0,cn=peercred,cn=external,cn=auth</b>). В случае
использования <b>conf</b>-файла необходимо указать пароль для
<b>rootdn</b>. Пользователь <b>rootdn</b> имеет права на чтение и запись для
всего содержимого. Знак "<b>*</b>" в ACL применяется ко всем записям, кроме
записи <b>rootdn</b>.
</p>

</div>

<p>
Если же потребуется тщательно настраивать конфигурацию с нуля,
полностью контролируя все параметры которые будут задействованы, то
нужно воспользоваться вторым способом &#x2014; дополнительным.
</p>
</div>
</div>

<div id="outline-container-orgheadline6" class="outline-3">
<h3 id="configure-slapd-conf"><a id="orgheadline6"></a><a id="ID-fd3e3e26-d416-4cc5-9dfa-554caeaf7830"></a><span class="section-number-3">1.5</span> Предварительная настройка схемы каталога LDAP</h3>
<div class="outline-text-3" id="text-configure-slapd-conf">
<p class="verse">
Где работаем: контейнеры <b>server-conf.</b><br  />
</p>

<p>
Продемонстрируем первый способ настройки. Внесем небольшие
изменения в конфигурационный файл для <b>5/2.3</b>
</p>

<div align="right">
<a onclick="toggleDiv2('myContent',$(this));" class="fa fa-caret-right">/root/slapd.conf</a>
</div>
<div id="myContent" style="display:none">
<div class="org-src-container">
<label class="org-src-name">Конфигурационный файл для <b>5/2.3</b></label>
<pre class="src src-conf-space"><span style="color: #93a1a1;">#</span>
<span style="color: #93a1a1;"># </span><span style="color: #93a1a1;">See slapd.conf(5) for details on configuration options.</span>
<span style="color: #93a1a1;"># </span><span style="color: #93a1a1;">This file should NOT be world readable.</span>
<span style="color: #93a1a1;">#</span>
<span style="color: #268bd2;">include</span>         /etc/openldap/schema/core.schema
<span style="color: #268bd2;">include</span>         /etc/openldap/schema/cosine.schema
<span style="color: #268bd2;">include</span>         /etc/openldap/schema/inetorgperson.schema
<span style="color: #268bd2;">include</span>         /etc/openldap/schema/nis.schema
<span style="color: #268bd2;">include</span>         /etc/openldap/schema/sudo.schema
<span style="color: #268bd2;">include</span>         /etc/openldap/schema/misc.schema
<span style="color: #268bd2;">include</span>         /etc/openldap/schema/ppolicy.schema

<span style="color: #93a1a1;"># </span><span style="color: #93a1a1;">Allow LDAPv2 client connections.  This is NOT the default.</span>
<span style="color: #268bd2;">allow</span> bind_v2

<span style="color: #93a1a1;"># </span><span style="color: #93a1a1;">Do not enable referrals until AFTER you have a working directory</span>
<span style="color: #93a1a1;"># </span><span style="color: #93a1a1;">service AND an understanding of referrals.</span>
<span style="color: #93a1a1;">#</span><span style="color: #93a1a1;">referral       ldap://root.openldap.org</span>

<span style="color: #268bd2;">pidfile</span>         /var/run/openldap/slapd.pid
<span style="color: #268bd2;">argsfile</span>        /var/run/openldap/slapd.args

<span style="color: #93a1a1;"># </span><span style="color: #93a1a1;">Load dynamic backend modules:</span>
<span style="color: #268bd2;">modulepath</span>      /usr/lib64/openldap

<span style="color: #93a1a1;"># </span><span style="color: #93a1a1;">Modules available in openldap-servers-overlays RPM package</span>
<span style="color: #93a1a1;"># </span><span style="color: #93a1a1;">Module syncprov.la is now statically linked with slapd and there</span>
<span style="color: #93a1a1;"># </span><span style="color: #93a1a1;">is no need to load it here</span>
<span style="color: #93a1a1;"># </span><span style="color: #93a1a1;">moduleload accesslog.la</span>
<span style="color: #93a1a1;"># </span><span style="color: #93a1a1;">moduleload auditlog.la</span>
<span style="color: #93a1a1;"># </span><span style="color: #93a1a1;">moduleload denyop.la</span>
<span style="color: #93a1a1;"># </span><span style="color: #93a1a1;">moduleload dyngroup.la</span>
<span style="color: #93a1a1;"># </span><span style="color: #93a1a1;">moduleload dynlist.la</span>
<span style="color: #93a1a1;"># </span><span style="color: #93a1a1;">moduleload lastmod.la</span>
<span style="color: #93a1a1;"># </span><span style="color: #93a1a1;">moduleload pcache.la</span>
<span style="color: #268bd2;">moduleload</span> ppolicy.la
<span style="color: #93a1a1;"># </span><span style="color: #93a1a1;">moduleload refint.la</span>
<span style="color: #93a1a1;"># </span><span style="color: #93a1a1;">moduleload retcode.la</span>
<span style="color: #93a1a1;"># </span><span style="color: #93a1a1;">moduleload rwm.la</span>
<span style="color: #93a1a1;"># </span><span style="color: #93a1a1;">moduleload smbk5pwd.la</span>
<span style="color: #93a1a1;"># </span><span style="color: #93a1a1;">moduleload translucent.la</span>
<span style="color: #93a1a1;"># </span><span style="color: #93a1a1;">moduleload unique.la</span>
<span style="color: #93a1a1;"># </span><span style="color: #93a1a1;">moduleload valsort.la</span>

<span style="color: #93a1a1;"># </span><span style="color: #93a1a1;">modules available in openldap-servers-sql RPM package:</span>
<span style="color: #93a1a1;"># </span><span style="color: #93a1a1;">moduleload back_sql.la</span>

<span style="color: #93a1a1;"># </span><span style="color: #93a1a1;">The next three lines allow use of TLS for encrypting connections using a</span>
<span style="color: #93a1a1;"># </span><span style="color: #93a1a1;">dummy test certificate which you can generate by changing to</span>
<span style="color: #93a1a1;"># </span><span style="color: #93a1a1;">/etc/pki/tls/certs, running "make slapd.pem", and fixing permissions on</span>
<span style="color: #93a1a1;"># </span><span style="color: #93a1a1;">slapd.pem so that the ldap user or group can read it.  Your client software</span>
<span style="color: #93a1a1;"># </span><span style="color: #93a1a1;">may balk at self-signed certificates, however.</span>
<span style="color: #93a1a1;"># </span><span style="color: #93a1a1;">TLSCACertificateFile /etc/pki/tls/certs/ca-bundle.crt</span>
<span style="color: #93a1a1;"># </span><span style="color: #93a1a1;">TLSCertificateFile /etc/pki/tls/certs/slapd.pem</span>
<span style="color: #93a1a1;"># </span><span style="color: #93a1a1;">TLSCertificateKeyFile /etc/pki/tls/certs/slapd.pem</span>

<span style="color: #93a1a1;"># </span><span style="color: #93a1a1;">Sample security restrictions</span>
<span style="color: #93a1a1;">#       </span><span style="color: #93a1a1;">Require integrity protection (prevent hijacking)</span>
<span style="color: #93a1a1;">#       </span><span style="color: #93a1a1;">Require 112-bit (3DES or better) encryption for updates</span>
<span style="color: #93a1a1;">#       </span><span style="color: #93a1a1;">Require 63-bit encryption for simple bind</span>
<span style="color: #93a1a1;"># </span><span style="color: #93a1a1;">security ssf=1 update_ssf=112 simple_bind=64</span>

<span style="color: #93a1a1;"># </span><span style="color: #93a1a1;">Sample access control policy:</span>
<span style="color: #93a1a1;">#       </span><span style="color: #93a1a1;">Root DSE: allow anyone to read it</span>
<span style="color: #93a1a1;">#       </span><span style="color: #93a1a1;">Subschema (sub)entry DSE: allow anyone to read it</span>
<span style="color: #93a1a1;">#       </span><span style="color: #93a1a1;">Other DSEs:</span>
<span style="color: #93a1a1;">#               </span><span style="color: #93a1a1;">Allow self write access</span>
<span style="color: #93a1a1;">#               </span><span style="color: #93a1a1;">Allow authenticated users read access</span>
<span style="color: #93a1a1;">#               </span><span style="color: #93a1a1;">Allow anonymous users to authenticate</span>
<span style="color: #93a1a1;">#       </span><span style="color: #93a1a1;">Directives needed to implement policy:</span>
<span style="color: #93a1a1;"># </span><span style="color: #93a1a1;">access to dn.base="" by * read</span>
<span style="color: #93a1a1;"># </span><span style="color: #93a1a1;">access to dn.base="cn=Subschema" by * read</span>
<span style="color: #93a1a1;"># </span><span style="color: #93a1a1;">access to *</span>
<span style="color: #93a1a1;">#       </span><span style="color: #93a1a1;">by self write</span>
<span style="color: #93a1a1;">#       </span><span style="color: #93a1a1;">by users read</span>
<span style="color: #93a1a1;">#       </span><span style="color: #93a1a1;">by anonymous auth</span>
<span style="color: #93a1a1;">#</span>
<span style="color: #93a1a1;"># </span><span style="color: #93a1a1;">if no access controls are present, the default policy</span>
<span style="color: #93a1a1;"># </span><span style="color: #93a1a1;">allows anyone and everyone to read anything but restricts</span>
<span style="color: #93a1a1;"># </span><span style="color: #93a1a1;">updates to rootdn.  (e.g., "access to * by * read")</span>
<span style="color: #93a1a1;">#</span>
<span style="color: #93a1a1;"># </span><span style="color: #93a1a1;">rootdn can always read and write EVERYTHING!</span>

<span style="color: #93a1a1;">#######################################################################</span>
<span style="color: #93a1a1;"># </span><span style="color: #93a1a1;">ldbm and/or bdb database definitions</span>
<span style="color: #93a1a1;">#######################################################################</span>
<span style="color: #268bd2;">database</span>        config
<span style="color: #268bd2;">rootdn</span>          <span style="color: #2aa198;">"cn=Manager,cn=config"</span>
<span style="color: #268bd2;">rootpw</span>          %LDAP_ROOT_PASSWORD%

<span style="color: #268bd2;">database</span> monitor

<span style="color: #268bd2;">database</span>        hdb
<span style="color: #268bd2;">suffix</span>          <span style="color: #2aa198;">"dc=my-domain,dc=com"</span>
<span style="color: #268bd2;">rootdn</span>          <span style="color: #2aa198;">"cn=Manager,dc=my-domain,dc=com"</span>
<span style="color: #93a1a1;"># </span><span style="color: #93a1a1;">Cleartext passwords, especially for the rootdn, should</span>
<span style="color: #93a1a1;"># </span><span style="color: #93a1a1;">be avoided.  See slappasswd(8) and slapd.conf(5) for details.</span>
<span style="color: #93a1a1;"># </span><span style="color: #93a1a1;">Use of strong authentication encouraged.</span>
<span style="color: #93a1a1;"># </span><span style="color: #93a1a1;">rootpw                secret</span>
<span style="color: #93a1a1;"># </span><span style="color: #93a1a1;">rootpw                {crypt}ijFYNcSNctBYg</span>

<span style="color: #93a1a1;"># </span><span style="color: #93a1a1;">The database directory MUST exist prior to running slapd AND </span>
<span style="color: #93a1a1;"># </span><span style="color: #93a1a1;">should only be accessible by the slapd and slap tools.</span>
<span style="color: #93a1a1;"># </span><span style="color: #93a1a1;">Mode 700 recommended.</span>
<span style="color: #268bd2;">directory</span>       /var/lib/ldap

<span style="color: #93a1a1;"># </span><span style="color: #93a1a1;">Indices to maintain for this database</span>
<span style="color: #268bd2;">index</span> objectClass                       eq,pres
<span style="color: #268bd2;">index</span> ou,cn,mail,surname,givenname      eq,pres,sub
<span style="color: #268bd2;">index</span> uidNumber,gidNumber,loginShell    eq,pres
<span style="color: #268bd2;">index</span> uid,memberUid                     eq,pres,sub
<span style="color: #268bd2;">index</span> nisMapName,nisMapEntry            eq,pres,sub

<span style="color: #93a1a1;"># </span><span style="color: #93a1a1;">Replicas of this database</span>
<span style="color: #93a1a1;">#</span><span style="color: #93a1a1;">replogfile /var/lib/ldap/openldap-master-replog</span>
<span style="color: #93a1a1;">#</span><span style="color: #93a1a1;">replica host=ldap-1.example.com:389 starttls=critical</span>
<span style="color: #93a1a1;">#     </span><span style="color: #93a1a1;">bindmethod=sasl saslmech=GSSAPI</span>
<span style="color: #93a1a1;">#     </span><span style="color: #93a1a1;">authcId=host/ldap-master.example.com@EXAMPLE.COM</span>

<span style="color: #268bd2;">overlay</span> ppolicy
<span style="color: #268bd2;">ppolicy_default</span> <span style="color: #2aa198;">"cn=passwordDefault,ou=policies,dc=my-domain,dc=com</span>
</pre>
</div>
</div>
<div class="org-src-container">
<label class="org-src-name">Настройка <b>conf</b>-файла для <b>5/2.3</b></label>
<pre class="src src-diff"><span style="background-color: #fdf6e3;">8a9,11</span>
<span style="color: #859900;">&gt;</span><span style="color: #859900;"> include               /etc/openldap/schema/sudo.schema</span>
<span style="color: #859900;">&gt;</span><span style="color: #859900;"> include               /etc/openldap/schema/misc.schema</span>
<span style="color: #859900;">&gt;</span><span style="color: #859900;"> include               /etc/openldap/schema/ppolicy.schema</span>
<span style="background-color: #fdf6e3;">21c24</span>
<span style="color: #dc322f;">&lt;</span><span style="color: #dc322f;"> # modulepath  /usr/lib64/openldap</span>
<span style="background-color: #fdf6e3;">---</span>
<span style="color: #859900;">&gt;</span><span style="color: #859900;"> modulepath    /usr/lib64/openldap</span>
<span style="background-color: #fdf6e3;">33c36</span>
<span style="color: #dc322f;">&lt;</span><span style="color: #dc322f;"> # moduleload ppolicy.la</span>
<span style="background-color: #fdf6e3;">---</span>
<span style="color: #859900;">&gt;</span><span style="color: #859900;"> moduleload ppolicy.la</span>
<span style="background-color: #fdf6e3;">83a87,89</span>
<span style="color: #859900;">&gt;</span><span style="color: #859900;"> database      config</span>
<span style="color: #859900;">&gt;</span><span style="color: #859900;"> rootdn                "cn=Manager,cn=config"</span>
<span style="color: #859900;">&gt;</span><span style="color: #859900;"> rootpw                {SSHA}SU5TvGLX/MoNX5pCYIaLQgz3jx9WDgx0</span>
<span style="background-color: #fdf6e3;">85c91,93</span>
<span style="color: #dc322f;">&lt;</span><span style="color: #dc322f;"> database      bdb</span>
<span style="background-color: #fdf6e3;">---</span>
<span style="color: #859900;">&gt;</span><span style="color: #859900;"> database monitor</span>
<span style="color: #859900;">&gt;</span><span style="color: #859900;"> </span>
<span style="color: #859900;">&gt;</span><span style="color: #859900;"> database      hdb</span>
<span style="background-color: #fdf6e3;">110a119,121</span>
<span style="color: #859900;">&gt;</span><span style="color: #859900;"> </span>
<span style="color: #859900;">&gt;</span><span style="color: #859900;"> overlay ppolicy</span>
<span style="color: #859900;">&gt;</span><span style="color: #859900;"> ppolicy_default "cn=passwordDefault,ou=policies,dc=my-domain,dc=com</span>
<span style="color: #93a1a1;">\ No newline at end of file</span>
</pre>
</div>
<p>
и произведем первый запуск сервиса
</p>
<div class="org-src-container">
<label class="org-src-name">Первый запуск сервиса для <b>5/2.3</b></label>
<pre class="src src-sh">    mv /etc/openldap/slapd.conf /etc/openldap/slapd.conf.original
    cp /root/slapd.conf /etc/openldap/slapd.conf
    <span style="color: #268bd2;">ROOT_PWD</span>=$(<span style="color: #6c71c4; font-weight: bold;">slappasswd</span> -s $<span style="color: #268bd2;">LDAP_ROOT_PASSWORD</span>)
    <span style="color: #93a1a1;"># </span><span style="color: #93a1a1;">Use bash variable substitution to escape special chars http://stackoverflow.com/a/14339705</span>
    sed -i <span style="color: #2aa198;">"s+%LDAP_ROOT_PASSWORD%+${ROOT_PWD//+/\\+}+"</span> /etc/openldap/slapd.conf
    chown ldap. /etc/openldap/slapd.conf

    diff /etc/openldap/slapd.conf.original /etc/openldap/slapd.conf &gt; /gen/slapd.diff || true
    service ldap start
</pre>
</div>
<p>
Выполним аналогичные действия для <b>6/2.4</b>
</p>

<div align="right">
<a onclick="toggleDiv2('myContent2',$(this));" class="fa fa-caret-right">/root/slapd.conf.obsolete</a>
</div>
<div id="myContent2" style="display:none">
<div class="org-src-container">
<label class="org-src-name">Конфигурационный файл для <b>6/2.4</b></label>
<pre class="src src-conf-space"><span style="color: #93a1a1;">#</span>
<span style="color: #93a1a1;"># </span><span style="color: #93a1a1;">See slapd.conf(5) for details on configuration options.</span>
<span style="color: #93a1a1;"># </span><span style="color: #93a1a1;">This file should NOT be world readable.</span>
<span style="color: #93a1a1;">#</span>

<span style="color: #268bd2;">include</span>         /etc/openldap/schema/corba.schema
<span style="color: #268bd2;">include</span>         /etc/openldap/schema/core.schema
<span style="color: #268bd2;">include</span>         /etc/openldap/schema/cosine.schema
<span style="color: #268bd2;">include</span>         /etc/openldap/schema/duaconf.schema
<span style="color: #268bd2;">include</span>         /etc/openldap/schema/dyngroup.schema
<span style="color: #268bd2;">include</span>         /etc/openldap/schema/inetorgperson.schema
<span style="color: #268bd2;">include</span>         /etc/openldap/schema/java.schema
<span style="color: #268bd2;">include</span>         /etc/openldap/schema/misc.schema
<span style="color: #268bd2;">include</span>         /etc/openldap/schema/nis.schema
<span style="color: #268bd2;">include</span>         /etc/openldap/schema/openldap.schema
<span style="color: #268bd2;">include</span>         /etc/openldap/schema/ppolicy.schema
<span style="color: #268bd2;">include</span>         /etc/openldap/schema/collective.schema
<span style="color: #268bd2;">include</span>         /etc/openldap/schema/sudo.schema

<span style="color: #93a1a1;"># </span><span style="color: #93a1a1;">Allow LDAPv2 client connections.  This is NOT the default.</span>
<span style="color: #268bd2;">allow</span> bind_v2

<span style="color: #93a1a1;"># </span><span style="color: #93a1a1;">Do not enable referrals until AFTER you have a working directory</span>
<span style="color: #93a1a1;"># </span><span style="color: #93a1a1;">service AND an understanding of referrals.</span>
<span style="color: #93a1a1;">#</span><span style="color: #93a1a1;">referral       ldap://root.openldap.org</span>

<span style="color: #268bd2;">pidfile</span>         /var/run/openldap/slapd.pid
<span style="color: #268bd2;">argsfile</span>        /var/run/openldap/slapd.args

<span style="color: #93a1a1;"># </span><span style="color: #93a1a1;">Load dynamic backend modules</span>
<span style="color: #93a1a1;"># </span><span style="color: #93a1a1;">- modulepath is architecture dependent value (32/64-bit system)</span>
<span style="color: #93a1a1;"># </span><span style="color: #93a1a1;">- back_sql.la overlay requires openldap-server-sql package</span>
<span style="color: #93a1a1;"># </span><span style="color: #93a1a1;">- dyngroup.la and dynlist.la cannot be used at the same time</span>

<span style="color: #93a1a1;"># </span><span style="color: #93a1a1;">modulepath /usr/lib/openldap</span>
<span style="color: #93a1a1;"># </span><span style="color: #93a1a1;">modulepath /usr/lib64/openldap</span>

<span style="color: #93a1a1;"># </span><span style="color: #93a1a1;">moduleload accesslog.la</span>
<span style="color: #93a1a1;"># </span><span style="color: #93a1a1;">moduleload auditlog.la</span>
<span style="color: #93a1a1;"># </span><span style="color: #93a1a1;">moduleload back_sql.la</span>
<span style="color: #93a1a1;"># </span><span style="color: #93a1a1;">moduleload chain.la</span>
<span style="color: #93a1a1;"># </span><span style="color: #93a1a1;">moduleload collect.la</span>
<span style="color: #93a1a1;"># </span><span style="color: #93a1a1;">moduleload constraint.la</span>
<span style="color: #93a1a1;"># </span><span style="color: #93a1a1;">moduleload dds.la</span>
<span style="color: #93a1a1;"># </span><span style="color: #93a1a1;">moduleload deref.la</span>
<span style="color: #93a1a1;"># </span><span style="color: #93a1a1;">moduleload dyngroup.la</span>
<span style="color: #93a1a1;"># </span><span style="color: #93a1a1;">moduleload dynlist.la</span>
<span style="color: #93a1a1;"># </span><span style="color: #93a1a1;">moduleload memberof.la</span>
<span style="color: #93a1a1;"># </span><span style="color: #93a1a1;">moduleload pbind.la</span>
<span style="color: #93a1a1;"># </span><span style="color: #93a1a1;">moduleload pcache.la</span>
<span style="color: #268bd2;">moduleload</span> ppolicy.la
<span style="color: #93a1a1;"># </span><span style="color: #93a1a1;">moduleload refint.la</span>
<span style="color: #93a1a1;"># </span><span style="color: #93a1a1;">moduleload retcode.la</span>
<span style="color: #93a1a1;"># </span><span style="color: #93a1a1;">moduleload rwm.la</span>
<span style="color: #93a1a1;"># </span><span style="color: #93a1a1;">moduleload seqmod.la</span>
<span style="color: #93a1a1;"># </span><span style="color: #93a1a1;">moduleload smbk5pwd.la</span>
<span style="color: #93a1a1;"># </span><span style="color: #93a1a1;">moduleload sssvlv.la</span>
<span style="color: #93a1a1;"># </span><span style="color: #93a1a1;">moduleload syncprov.la</span>
<span style="color: #93a1a1;"># </span><span style="color: #93a1a1;">moduleload translucent.la</span>
<span style="color: #93a1a1;"># </span><span style="color: #93a1a1;">moduleload unique.la</span>
<span style="color: #93a1a1;"># </span><span style="color: #93a1a1;">moduleload valsort.la</span>

<span style="color: #93a1a1;"># </span><span style="color: #93a1a1;">The next three lines allow use of TLS for encrypting connections using a</span>
<span style="color: #93a1a1;"># </span><span style="color: #93a1a1;">dummy test certificate which you can generate by running</span>
<span style="color: #93a1a1;"># </span><span style="color: #93a1a1;">/usr/libexec/openldap/generate-server-cert.sh. Your client software may balk</span>
<span style="color: #93a1a1;"># </span><span style="color: #93a1a1;">at self-signed certificates, however.</span>
<span style="color: #268bd2;">TLSCACertificatePath</span> /etc/openldap/certs
<span style="color: #268bd2;">TLSCertificateFile</span> <span style="color: #2aa198;">"\"OpenLDAP Server\""</span>
<span style="color: #268bd2;">TLSCertificateKeyFile</span> /etc/openldap/certs/password

<span style="color: #93a1a1;"># </span><span style="color: #93a1a1;">Sample security restrictions</span>
<span style="color: #93a1a1;">#       </span><span style="color: #93a1a1;">Require integrity protection (prevent hijacking)</span>
<span style="color: #93a1a1;">#       </span><span style="color: #93a1a1;">Require 112-bit (3DES or better) encryption for updates</span>
<span style="color: #93a1a1;">#       </span><span style="color: #93a1a1;">Require 63-bit encryption for simple bind</span>
<span style="color: #93a1a1;"># </span><span style="color: #93a1a1;">security ssf=1 update_ssf=112 simple_bind=64</span>

<span style="color: #93a1a1;"># </span><span style="color: #93a1a1;">Sample access control policy:</span>
<span style="color: #93a1a1;">#       </span><span style="color: #93a1a1;">Root DSE: allow anyone to read it</span>
<span style="color: #93a1a1;">#       </span><span style="color: #93a1a1;">Subschema (sub)entry DSE: allow anyone to read it</span>
<span style="color: #93a1a1;">#       </span><span style="color: #93a1a1;">Other DSEs:</span>
<span style="color: #93a1a1;">#               </span><span style="color: #93a1a1;">Allow self write access</span>
<span style="color: #93a1a1;">#               </span><span style="color: #93a1a1;">Allow authenticated users read access</span>
<span style="color: #93a1a1;">#               </span><span style="color: #93a1a1;">Allow anonymous users to authenticate</span>
<span style="color: #93a1a1;">#       </span><span style="color: #93a1a1;">Directives needed to implement policy:</span>
<span style="color: #93a1a1;"># </span><span style="color: #93a1a1;">access to dn.base="" by * read</span>
<span style="color: #93a1a1;"># </span><span style="color: #93a1a1;">access to dn.base="cn=Subschema" by * read</span>
<span style="color: #93a1a1;"># </span><span style="color: #93a1a1;">access to *</span>
<span style="color: #93a1a1;">#       </span><span style="color: #93a1a1;">by self write</span>
<span style="color: #93a1a1;">#       </span><span style="color: #93a1a1;">by users read</span>
<span style="color: #93a1a1;">#       </span><span style="color: #93a1a1;">by anonymous auth</span>
<span style="color: #93a1a1;">#</span>
<span style="color: #93a1a1;"># </span><span style="color: #93a1a1;">if no access controls are present, the default policy</span>
<span style="color: #93a1a1;"># </span><span style="color: #93a1a1;">allows anyone and everyone to read anything but restricts</span>
<span style="color: #93a1a1;"># </span><span style="color: #93a1a1;">updates to rootdn.  (e.g., "access to * by * read")</span>
<span style="color: #93a1a1;">#</span>
<span style="color: #93a1a1;"># </span><span style="color: #93a1a1;">rootdn can always read and write EVERYTHING!</span>

<span style="color: #93a1a1;"># </span><span style="color: #93a1a1;">enable on-the-fly configuration (cn=config)</span>
<span style="color: #268bd2;">database</span> config
<span style="color: #268bd2;">access</span> to *
        <span style="color: #268bd2;">by</span> dn.exact=<span style="color: #2aa198;">"gidNumber=0+uidNumber=0,cn=peercred,cn=external,cn=auth"</span> manage
        <span style="color: #268bd2;">by</span> * none

<span style="color: #268bd2;">rootdn</span>          <span style="color: #2aa198;">"cn=Manager,cn=config"</span>
<span style="color: #268bd2;">rootpw</span>          %LDAP_ROOT_PASSWORD%

<span style="color: #93a1a1;"># </span><span style="color: #93a1a1;">enable server status monitoring (cn=monitor)</span>
<span style="color: #268bd2;">database</span> monitor
<span style="color: #268bd2;">access</span> to *
        <span style="color: #268bd2;">by</span> dn.exact=<span style="color: #2aa198;">"gidNumber=0+uidNumber=0,cn=peercred,cn=external,cn=auth"</span> read
        <span style="color: #268bd2;">by</span> dn.exact=<span style="color: #2aa198;">"cn=Manager,dc=my-domain,dc=com"</span> read
        <span style="color: #268bd2;">by</span> * none

<span style="color: #93a1a1;">#######################################################################</span>
<span style="color: #93a1a1;"># </span><span style="color: #93a1a1;">database definitions</span>
<span style="color: #93a1a1;">#######################################################################</span>

<span style="color: #268bd2;">database</span>        hdb
<span style="color: #268bd2;">suffix</span>          <span style="color: #2aa198;">"dc=my-domain,dc=com"</span>
<span style="color: #268bd2;">checkpoint</span>      1024 15
<span style="color: #268bd2;">rootdn</span>          <span style="color: #2aa198;">"cn=Manager,dc=my-domain,dc=com"</span>
<span style="color: #93a1a1;"># </span><span style="color: #93a1a1;">Cleartext passwords, especially for the rootdn, should</span>
<span style="color: #93a1a1;"># </span><span style="color: #93a1a1;">be avoided.  See slappasswd(8) and slapd.conf(5) for details.</span>
<span style="color: #93a1a1;"># </span><span style="color: #93a1a1;">Use of strong authentication encouraged.</span>
<span style="color: #93a1a1;"># </span><span style="color: #93a1a1;">rootpw                secret</span>
<span style="color: #93a1a1;"># </span><span style="color: #93a1a1;">rootpw                {crypt}ijFYNcSNctBYg</span>

<span style="color: #93a1a1;"># </span><span style="color: #93a1a1;">The database directory MUST exist prior to running slapd AND </span>
<span style="color: #93a1a1;"># </span><span style="color: #93a1a1;">should only be accessible by the slapd and slap tools.</span>
<span style="color: #93a1a1;"># </span><span style="color: #93a1a1;">Mode 700 recommended.</span>
<span style="color: #268bd2;">directory</span>       /var/lib/ldap

<span style="color: #93a1a1;"># </span><span style="color: #93a1a1;">Indices to maintain for this database</span>
<span style="color: #268bd2;">index</span> objectClass                       eq,pres
<span style="color: #268bd2;">index</span> ou,cn,mail,surname,givenname      eq,pres,sub
<span style="color: #268bd2;">index</span> uidNumber,gidNumber,loginShell    eq,pres
<span style="color: #268bd2;">index</span> uid,memberUid                     eq,pres,sub
<span style="color: #268bd2;">index</span> nisMapName,nisMapEntry            eq,pres,sub

<span style="color: #93a1a1;"># </span><span style="color: #93a1a1;">Replicas of this database</span>
<span style="color: #93a1a1;">#</span><span style="color: #93a1a1;">replogfile /var/lib/ldap/openldap-master-replog</span>
<span style="color: #93a1a1;">#</span><span style="color: #93a1a1;">replica host=ldap-1.example.com:389 starttls=critical</span>
<span style="color: #93a1a1;">#     </span><span style="color: #93a1a1;">bindmethod=sasl saslmech=GSSAPI</span>
<span style="color: #93a1a1;">#     </span><span style="color: #93a1a1;">authcId=host/ldap-master.example.com@EXAMPLE.COM</span>

<span style="color: #268bd2;">overlay</span> ppolicy
<span style="color: #268bd2;">ppolicy_default</span> <span style="color: #2aa198;">"cn=passwordDefault,ou=policies,dc=my-domain,dc=com</span>
</pre>
</div>
</div>
<div class="org-src-container">
<label class="org-src-name">Настройка <b>conf</b>-файла для <b>6/2.4</b></label>
<pre class="src src-diff"><span style="background-color: #fdf6e3;">17a18</span>
<span style="color: #859900;">&gt;</span><span style="color: #859900;"> include               /etc/openldap/schema/sudo.schema</span>
<span style="background-color: #fdf6e3;">50c51</span>
<span style="color: #dc322f;">&lt;</span><span style="color: #dc322f;"> # moduleload ppolicy.la</span>
<span style="background-color: #fdf6e3;">---</span>
<span style="color: #859900;">&gt;</span><span style="color: #859900;"> moduleload ppolicy.la</span>
<span style="background-color: #fdf6e3;">102a104,106</span>
<span style="color: #859900;">&gt;</span><span style="color: #859900;"> rootdn                "cn=Manager,cn=config"</span>
<span style="color: #859900;">&gt;</span><span style="color: #859900;"> rootpw          {SSHA}Xs78eHOwcPoJrSohxbU3Fig1F84GAenX</span>
<span style="color: #859900;">&gt;</span><span style="color: #859900;"> </span>
<span style="background-color: #fdf6e3;">114c118</span>
<span style="color: #dc322f;">&lt;</span><span style="color: #dc322f;"> database      bdb</span>
<span style="background-color: #fdf6e3;">---</span>
<span style="color: #859900;">&gt;</span><span style="color: #859900;"> database      hdb</span>
<span style="background-color: #fdf6e3;">140a145,147</span>
<span style="color: #859900;">&gt;</span><span style="color: #859900;"> </span>
<span style="color: #859900;">&gt;</span><span style="color: #859900;"> overlay ppolicy</span>
<span style="color: #859900;">&gt;</span><span style="color: #859900;"> ppolicy_default "cn=passwordDefault,ou=policies,dc=my-domain,dc=com</span>
<span style="color: #93a1a1;">\ No newline at end of file</span>
</pre>
</div>

<div class="org-src-container">
<label class="org-src-name">Первый запуск сервиса для <b>6/2.4</b></label>
<pre class="src src-sh">    cp /root/slapd.conf.obsolete /etc/openldap/slapd.conf
    <span style="color: #268bd2;">ROOT_PWD</span>=$(<span style="color: #6c71c4; font-weight: bold;">slappasswd</span> -s $<span style="color: #268bd2;">LDAP_ROOT_PASSWORD</span>)
    <span style="color: #93a1a1;"># </span><span style="color: #93a1a1;">Use bash variable substitution to escape special chars http://stackoverflow.com/a/14339705</span>
    sed -i <span style="color: #2aa198;">"s+%LDAP_ROOT_PASSWORD%+${ROOT_PWD//+/\\+}+"</span> /etc/openldap/slapd.conf
    chown ldap. /etc/openldap/slapd.conf
    rm -rf /etc/openldap/slapd.d

    diff /usr/share/openldap-servers/slapd.conf.obsolete /etc/openldap/slapd.conf &gt; /gen/slapd.obsolete.diff || true
    service slapd start
</pre>
</div>

<p>
<a id="orgtarget1"></a>Теперь для обеих конфигураций можно осуществить переход к <b>ldif</b> формату и избавиться от <b>slapd.conf</b>
</p>
<div class="org-src-container">
<label class="org-src-name">Преобразование к <b>ldif</b> формату для <b>5/2.3</b> и <b>6/2.4</b></label>
<pre class="src src-sh">    sleep 3

    <span style="color: #657b83; font-weight: bold;">kill</span> -INT <span style="color: #6c71c4; font-weight: bold;">`cat /var/run/openldap/slapd.pid`</span>
    rm -rf /etc/openldap/slapd.d
    <span style="color: #268bd2;">oldpath</span>=<span style="color: #6c71c4; font-weight: bold;">`pwd`</span>
    <span style="color: #657b83; font-weight: bold;">cd</span> /etc/openldap
    mkdir slapd.d
    slaptest -f slapd.conf -F slapd.d
    chown -R ldap:ldap slapd.d
    chmod -R 0750 slapd.d
    mv slapd.conf slapd.conf.bak
    <span style="color: #657b83; font-weight: bold;">cd</span> $<span style="color: #268bd2;">oldpath</span>
</pre>
</div>

<div class="note">
<p>
Если не осуществлять переход к <b>ldif</b> формату, ограничившись <b>conf</b>
файлом, необходимо либо все настройки файла <b>domain.ldif</b>
(см. подраздел <a href="#hdb-domain-config">3.2</a>) перенести в <b>conf</b> файл (записав их
в формате <b>conf</b> файла), либо загружать их каждый раз при перезапуске
сервиса. Использование <b>ldif</b> формата позволяет хранить все настройки
в директории <b>slapd.d</b>.
</p>

</div>

<p>
После перезапуска, для <b>5/2.3</b>
</p>
<div class="org-src-container">

<pre class="src src-sh">    service ldap start
</pre>
</div>
<p>
и для <b>6/2.4</b>
</p>
<div class="org-src-container">

<pre class="src src-sh">    service slapd start
</pre>
</div>
<p>
получаем сервисы, отличающиеся только настройками по умолчанию,
поставляемыми из базовых репозиториев в файлах
<b>/etc/openldap/slapd.conf</b> (<b>5/2.3</b>) и
<b>/usr/share/openldap-servers/slapd.conf.obsolete</b> (<b>6/2.4</b>).
</p>

<p>
Дальнейшая настройка схемы осуществляется в разделе <a href="#schema">3</a>.
</p>
</div>
</div>
<div id="outline-container-orgheadline7" class="outline-3">
<h3 id="configure-slapd"><a id="orgheadline7"></a><a id="ID-5e011bb7-7966-4613-8327-da484b6fd319"></a><span class="section-number-3">1.6</span> Дополнительно. Предварительная настройка схемы каталога LDAP с помощью ldif формата</h3>
<div class="outline-text-3" id="text-configure-slapd">
<p class="verse">
Где работаем: контейнеры <b>server-ldif.</b><br  />
</p>

<p>
Продемонстрируем второй способ настройки для обеих конфигураций.
</p>

<p>
Конфигурация <b>5/2.3</b> поставляется со схемами только в <b>schema</b>
формате, а <b>6/2.4</b> &#x2014; как в <b>schema</b>, так и в <b>ldif</b> формате. Файл
<b>sudo.schema</b> доступен только в <b>schema</b> формате. С помощью скрипта
<b>2.5-schema-ldif.sh</b><sup><a id="fnr.4" class="footref" href="#fn.4">4</a></sup>
преобразуем необходимые схемы. Чтобы иметь доступ к каталогу LDAP для
конфигурирования схемы, пропишем пароль менеджера схемы
<b>cn=Manager,cn=config</b>. Кроме того, добавим минимальные
настройки для <b>monitor</b> и настроим базу <b>HDB</b>. Используем
"оффлайновую" утилиту <b>slapadd</b> для создания минимума конфигурационных
настроек, позволяющих запустить сервер.
</p>

<div class="org-src-container">
<label class="org-src-name">Преобразование схем в <b>ldif</b> формат и задание начальной конфигурации</label>
<pre class="src src-sh">    rm -rf /etc/openldap/slapd.d
    rm -f /etc/openldap/slapd.conf
    mkdir -p /etc/openldap/slapd.d

    <span style="color: #268bd2;">oldpath</span>=<span style="color: #6c71c4; font-weight: bold;">`pwd`</span>
    <span style="color: #657b83; font-weight: bold;">cd</span> /etc/openldap/schema
    <span style="color: #268bd2;">SCHEMAD</span>=<span style="color: #6c71c4; font-weight: bold;">`pwd`</span> <span style="color: #268bd2;">SCHEMAS</span>=<span style="color: #2aa198;">'core.schema cosine.schema inetorgperson.schema nis.schema sudo.schema misc.schema ppolicy.schema'</span> /root/2.5-schema-ldif.sh
    cp -R /etc/openldap/schema /gen/schema
    <span style="color: #657b83; font-weight: bold;">cd</span> $<span style="color: #268bd2;">oldpath</span>

    <span style="color: #268bd2;">ROOT_PWD</span>=$(<span style="color: #6c71c4; font-weight: bold;">slappasswd</span> -s $<span style="color: #268bd2;">LDAP_ROOT_PASSWORD</span>)
    <span style="color: #93a1a1;"># </span><span style="color: #93a1a1;">Use bash variable substitution to escape special chars http://stackoverflow.com/a/14339705</span>
    sed -i <span style="color: #2aa198;">"s+%LDAP_ROOT_PASSWORD%+${ROOT_PWD//+/\\+}+"</span> /root/slapd.ldif
    slapadd -b <span style="color: #268bd2;">cn</span>=config -F /etc/openldap/slapd.d -l /root/slapd.ldif || true
    chown -R ldap. /etc/openldap/slapd.d/
</pre>
</div>
<div class="org-src-container">
<label class="org-src-name"><b>slapd.ldif</b>: формирование корневой записи DIT и контейнера для наборов схем данных; конфигурирование базы данных <b>HDB</b>, подключение мониторинга баз данных и загрузка модуля <b>ppolicy</b></label>
<pre class="src src-ldif" id="orgsrcblock1"><span style="color: #859900; font-weight: bold;">dn</span>: <span style="color: #268bd2;">cn=config</span>
objectClass: olcGlobal
olcPidFile: /var/run/openldap/slapd.pid
olcArgsFile: /var/run/openldap/slapd.args
cn: config

<span style="color: #859900; font-weight: bold;">dn</span>: <span style="color: #268bd2;">olcDatabase={0}config,cn=config</span>
objectClass: olcDatabaseConfig
olcDatabase: {0}config
olcRootDN: cn=Manager,cn=config
olcRootPW: %LDAP_ROOT_PASSWORD%

<span style="color: #859900; font-weight: bold;">dn</span>: <span style="color: #268bd2;">cn=schema,cn=config</span>
objectClass: olcSchemaConfig
cn: schema

include: file:///etc/openldap/schema/core.ldif
include: file:///etc/openldap/schema/cosine.ldif
include: file:///etc/openldap/schema/inetorgperson.ldif
include: file:///etc/openldap/schema/nis.ldif
include: file:///etc/openldap/schema/sudo.ldif
include: file:///etc/openldap/schema/misc.ldif
include: file:///etc/openldap/schema/ppolicy.ldif

<span style="color: #859900; font-weight: bold;">dn</span>: <span style="color: #268bd2;">olcDatabase=monitor,cn=config</span>
objectClass: olcDatabaseConfig
olcDatabase: monitor

<span style="color: #859900; font-weight: bold;">dn</span>: <span style="color: #268bd2;">olcDatabase=hdb,cn=config</span>
objectClass: olcDatabaseConfig
objectClass: olcHdbConfig
olcDatabase: hdb
olcSuffix: dc=my-domain,dc=com
olcRootDN: cn=Manager,dc=my-domain,dc=com
olcDbDirectory: /var/lib/ldap
olcDbIndex: objectClass                       eq,pres
olcDbIndex: ou,cn,mail,surname,givenname      eq,pres,sub
olcDbIndex: uidNumber,gidNumber,loginShell    eq,pres
olcDbIndex: uid,memberUid                     eq,pres,sub
olcDbIndex: nisMapName,nisMapEntry            eq,pres,sub

<span style="color: #859900; font-weight: bold;">dn</span>: <span style="color: #268bd2;">cn=module{0},cn=config</span>
objectClass: olcModuleList
olcModulePath: /usr/lib64/openldap
cn: module{0}
olcModuleLoad: ppolicy.la

<span style="color: #859900; font-weight: bold;">dn</span>: <span style="color: #268bd2;">olcOverlay=ppolicy,olcDatabase={2}hdb,cn=config</span>
objectClass: olcOverlayConfig
objectClass: olcPPolicyConfig
olcOverlay: ppolicy
olcPPolicyDefault: cn=passwordDefault,ou=policies,dc=my-domain,dc=com
olcPPolicyHashCleartext: FALSE
olcPPolicyUseLockout: FALSE
olcPPolicyForwardUpdates: FALSE
</pre>
</div>

<p>
После перезапуска, для <b>5/2.3</b>
</p>
<div class="org-src-container">

<pre class="src src-sh">    service ldap start
</pre>
</div>
<p>
и для <b>6/2.4</b>
</p>
<div class="org-src-container">

<pre class="src src-sh">    service slapd start
</pre>
</div>
<p>
получаем сервисы, отличающиеся только настройками схемы, содержащимися
в исходных кодах разных версий <b>OpenLDAP</b>.  Например, для конфигурации
<b>5/2.3</b> требуется добавить настройки <b>frontend</b> базы, а для <b>6/2.4</b>
эти настройки добавляются автоматически из исходного кода <b>OpenLDAP</b>
(что, кстати говоря, несколько нарушает прозрачность &#x2014; появляется то,
что явно не указано в файле <b>slapd.ldif</b>). Все дальнейшие изменения
уже осуществляются с помощью "онлайновых" утилит <b>ldapadd</b> и
<b>ldapmodify</b>.
</p>

<div class="org-src-container">
<label class="org-src-name">Добавление <b>frontend</b> для <b>5/2.3</b></label>
<pre class="src src-sh">    sleep 2

    ldapadd -v -D <span style="color: #268bd2;">cn</span>=Manager,<span style="color: #268bd2;">cn</span>=config -f /root/front.ldif -x -w $<span style="color: #268bd2;">LDAP_ROOT_PASSWORD</span> || true
</pre>
</div>

<p>
Специальная база данных <b>frontend</b> содержит настройки, которые
применяются глобально ко всем остальным базам данных. В нашем случае в
наличии одна база <b>HDB</b> и никаких специальных настроек для <b>frontend</b>.
</p>

<div class="org-src-container">
<label class="org-src-name"><b>front.ldif</b>: добавление служебной базы данных <b>frontend</b> (только для <b>5/2.3</b>)</label>
<pre class="src src-ldif" id="orgsrcblock2"><span style="color: #859900; font-weight: bold;">dn</span>: <span style="color: #268bd2;">olcDatabase={-1}frontend,cn=config</span>
objectClass: olcDatabaseConfig
objectClass: olcFrontendConfig
olcSchemaDN: cn=Subschema
olcDatabase: {-1}frontend
</pre>
</div>

<p>
Дальнейшая настройка схемы осуществляется в разделе <a href="#schema">3</a>.
</p>
</div>
</div>
</div>
<div id="outline-container-orgheadline18" class="outline-2">
<h2 id="authentication"><a id="orgheadline18"></a><a id="ID-49b5e2df-0c06-445a-ae9e-66bcd6cc9e40"></a><span class="section-number-2">2</span> Настройка аутентификации пользователей при помощи LDAP</h2>
<div class="outline-text-2" id="text-authentication">
<blockquote>
<p>
Необходимо разработать документацию по настройке аутентификации пользователей при помощи LDAP в ОС <b>CentOS 5</b>. Проверить работоспособность выработанных инструкций в ОС <b>CentOS 6</b>.
</p>

<p>
В документацию должно входить:
</p>

<ul class="org-ul">
<li>Список пакетов, которые необходимо установить;</li>
<li>Список файлов, модификация которых необходима для настройки процесса аутентификации посредством LDAP;</li>
<li>Описание всех опций, выставляемых в этих файлах.</li>
</ul>
</blockquote>

<p>
Рассмотрим три задачи, возникающие при настройке аутентификации
пользователей при помощи LDAP. Чтобы провести аутентификацию
пользователя необходимо, чтобы клиентский хост имел
право на чтение пользовательских данных на сервере LDAP. Для этого
потребуется обеспечить механизм аутентификации клиентского хоста при
помощи LDAP. Далее следует основная задача &#x2014; это, собственно, настройка
аутентификации пользователей в системе при помощи LDAP. И, наконец,
вспомогательная задача аутентификации пользователя с повышением прав.
</p>
</div>

<div id="outline-container-orgheadline9" class="outline-3">
<h3 id="client-packages"><a id="orgheadline9"></a><a id="ID-a4da4894-117b-40b6-a6c7-1447f083d6e1"></a><span class="section-number-3">2.1</span> Требуемые пакеты</h3>
<div class="outline-text-3" id="text-client-packages">
<p class="verse">
Где работаем: контейнеры <b>client.</b><br  />
</p>

<p>
Для настройки клиентского подключения в <b>5/2.3</b> понадобятся следующие пакеты
</p>

<div class="org-src-container">
<label class="org-src-name">Установка клиента для <b>5/2.3</b></label>
<pre class="src src-org">yum install -y openssh-server openldap-clients nss_ldap authconfig
yum install -y openldap openldap-servers finger sudo
yum install -y sendmail sendmail-cf
yum install -y libuser
</pre>
</div>

<p>
Здесь также необходим пакет <b>openldap-servers</b>, поскольку утилиты для миграции пользователей содержатся в нем. Для <b>6/2.4</b> выполним
</p>

<div class="org-src-container">
<label class="org-src-name">Установка клиента для <b>6/2.4</b></label>
<pre class="src src-org">yum install -y openssh-server openldap-clients nss-pam-ldapd authconfig
yum install -y openldap migrationtools finger sudo
yum install -y sendmail sendmail-cf
yum install -y libuser
</pre>
</div>
</div>
</div>

<div id="outline-container-orgheadline10" class="outline-3">
<h3 id="client-commands"><a id="orgheadline10"></a><a id="ID-6e7a8278-7334-46f7-b289-07da7f2b6d14"></a><span class="section-number-3">2.2</span> Используемые команды</h3>
<div class="outline-text-3" id="text-client-commands">
<p class="verse">
Где работаем: контейнеры <b>client.</b><br  />
</p>

<p>
Воспользуемся утилитой <b>authconfig</b> для настройки аутентификации пользователей при помощи LDAP.
</p>

<p>
В <b>5/2.3</b> приходится использовать параметр <b>enableshadow</b>, поскольку
эта функциональность отключена по умолчанию. Отдельно укажем параметр
<b>sudoers_base</b> и параметры <b>binddn</b> и <b>bindpw</b> в настройках для
<b>pam_ldap</b> (см. также настройки для <b>authenticator</b> в подразделе
<a href="#hdb-domain-config">3.2</a>).
</p>

<div class="org-src-container">
<label class="org-src-name">Настройка клиента для <b>5/2.3</b></label>
<pre class="src src-sh">authconfig --enableshadow --enablemkhomedir --enableldap --enableldapauth <span style="color: #b58900; font-weight: bold;">\</span>
           --ldapserver=$<span style="color: #268bd2;">LDAP_SERVER</span> --ldapbasedn=$<span style="color: #268bd2;">LDAP_BASEDN</span> --update

sed -i <span style="color: #2aa198;">"s|pam_mkhomedir.so|pam_mkhomedir.so skel=/etc/skel umask=0077|g"</span> /etc/pam.d/system-auth
<span style="color: #657b83; font-weight: bold;">echo</span> sudoers_base <span style="color: #268bd2;">dc</span>=mercury,<span style="color: #268bd2;">dc</span>=febras,<span style="color: #268bd2;">dc</span>=net &gt;&gt; /etc/ldap.conf
<span style="color: #657b83; font-weight: bold;">echo</span> sudoers_debug 0 &gt;&gt; /etc/ldap.conf
<span style="color: #657b83; font-weight: bold;">echo</span> binddn <span style="color: #268bd2;">uid</span>=authenticator,<span style="color: #268bd2;">ou</span>=system,<span style="color: #268bd2;">dc</span>=mercury,<span style="color: #268bd2;">dc</span>=febras,<span style="color: #268bd2;">dc</span>=net &gt;&gt; /etc/ldap.conf
<span style="color: #657b83; font-weight: bold;">echo</span> bindpw secret &gt;&gt; /etc/ldap.conf

chmod 600 /etc/ldap.conf

sed -i <span style="color: #2aa198;">"s|      positive-time-to-live   passwd          600|    positive-time-to-live   passwd          0|g"</span> /etc/nscd.conf
sed -i <span style="color: #2aa198;">"s|      negative-time-to-live   passwd          20|     negative-time-to-live   passwd          0|g"</span> /etc/nscd.conf

/etc/init.d/nscd start
</pre>
</div>

<div class="org-src-container">
<label class="org-src-name">Настройка libuser для <b>5/2.3</b> и <b>6/2.4</b></label>
<pre class="src src-sh">sed -i <span style="color: #2aa198;">"s|^modules = files shadow|modules = files shadow ldap|"</span> /etc/libuser.conf
sed -i <span style="color: #2aa198;">"s|create_modules = files shadow|create_modules = ldap files shadow|"</span> /etc/libuser.conf
sed -i <span style="color: #2aa198;">"s|# server = ldap|server = ldap://$LDAP_SERVER|"</span> /etc/libuser.conf
sed -i <span style="color: #2aa198;">"s|# basedn = dc=example,dc=com|basedn = $LDAP_BASEDN|"</span> /etc/libuser.conf
sed -i <span style="color: #2aa198;">"s|# userBranch = ou=People|userBranch = ou=users|"</span> /etc/libuser.conf
sed -i <span style="color: #2aa198;">"s|# groupBranch = ou=Group|groupBranch = ou=groups|"</span> /etc/libuser.conf
sed -i <span style="color: #2aa198;">"s|# binddn = cn=Manager,dc=example,dc=com|binddn = cn=Manager,dc=mercury,dc=febras,dc=net|"</span> /etc/libuser.conf
</pre>
</div>

<p>
Для <b>6/2.4</b> приходится отдельно прописывать параметр
<b>sudoers</b> для <b>nsswitch.conf</b>, а в <b>5/2.3</b> он уже
установлен еще до запуска <b>authconfig</b>. Для
настройки <b>sudo</b> дополнительно указываются параметры <b>uri</b> и <b>base</b>,
поскольку файл настроек теперь отдельный &#x2014; <b>sudo-ldap.conf</b>. А параметры
<b>binddn</b> и <b>bindpw</b> необходимо указать в 3х файлах: <b>nslcd.conf</b>,
<b>pam_ldap.conf</b> и <b>sudo-ldap.conf</b>.
</p>

<div class="org-src-container">
<label class="org-src-name">Настройка клиента для <b>6/2.4</b></label>
<pre class="src src-sh">authconfig --enablemkhomedir --enableldap --enableldapauth <span style="color: #b58900; font-weight: bold;">\</span>
           --ldapserver=$<span style="color: #268bd2;">LDAP_SERVER</span> --ldapbasedn=$<span style="color: #268bd2;">LDAP_BASEDN</span> --update

<span style="color: #657b83; font-weight: bold;">echo</span> sudoers:  files ldap &gt;&gt; /etc/nsswitch.conf

<span style="color: #657b83; font-weight: bold;">echo</span> uri ldap://$<span style="color: #268bd2;">LDAP_SERVER</span>/ &gt;&gt; /etc/sudo-ldap.conf
<span style="color: #657b83; font-weight: bold;">echo</span> base <span style="color: #268bd2;">dc</span>=mercury,<span style="color: #268bd2;">dc</span>=febras,<span style="color: #268bd2;">dc</span>=net &gt;&gt; /etc/sudo-ldap.conf
<span style="color: #657b83; font-weight: bold;">echo</span> sudoers_base <span style="color: #268bd2;">dc</span>=mercury,<span style="color: #268bd2;">dc</span>=febras,<span style="color: #268bd2;">dc</span>=net &gt;&gt; /etc/sudo-ldap.conf
<span style="color: #657b83; font-weight: bold;">echo</span> sudoers_debug 0 &gt;&gt; /etc/sudo-ldap.conf
<span style="color: #657b83; font-weight: bold;">echo</span> binddn <span style="color: #268bd2;">uid</span>=authenticator,<span style="color: #268bd2;">ou</span>=system,<span style="color: #268bd2;">dc</span>=mercury,<span style="color: #268bd2;">dc</span>=febras,<span style="color: #268bd2;">dc</span>=net &gt;&gt; /etc/sudo-ldap.conf
<span style="color: #657b83; font-weight: bold;">echo</span> bindpw secret &gt;&gt; /etc/sudo-ldap.conf

<span style="color: #657b83; font-weight: bold;">echo</span> binddn <span style="color: #268bd2;">uid</span>=authenticator,<span style="color: #268bd2;">ou</span>=system,<span style="color: #268bd2;">dc</span>=mercury,<span style="color: #268bd2;">dc</span>=febras,<span style="color: #268bd2;">dc</span>=net &gt;&gt; /etc/pam_ldap.conf
<span style="color: #657b83; font-weight: bold;">echo</span> bindpw secret &gt;&gt; /etc/pam_ldap.conf

<span style="color: #657b83; font-weight: bold;">echo</span> binddn <span style="color: #268bd2;">uid</span>=authenticator,<span style="color: #268bd2;">ou</span>=system,<span style="color: #268bd2;">dc</span>=mercury,<span style="color: #268bd2;">dc</span>=febras,<span style="color: #268bd2;">dc</span>=net &gt;&gt; /etc/nslcd.conf
<span style="color: #657b83; font-weight: bold;">echo</span> bindpw secret &gt;&gt; /etc/nslcd.conf

chmod 600 /etc/sudo-ldap.conf
chmod 600 /etc/pam_ldap.conf
chmod 600 /etc/nslcd.conf

/etc/init.d/nslcd stop
rm /var/run/nslcd/*
/etc/init.d/nslcd start
</pre>
</div>
</div>
</div>

<div id="outline-container-orgheadline11" class="outline-3">
<h3 id="client-files"><a id="orgheadline11"></a><a id="ID-386e40de-d1f2-4dc8-994b-5870d4ec42fb"></a><span class="section-number-3">2.3</span> Изменяемые файлы</h3>
<div class="outline-text-3" id="text-client-files">
<p>
Файлы, которые были модифицированы настройками подраздела <a href="#client-commands">2.2</a> в случае <b>5/2.3</b>
</p>

<ul class="org-ul">
<li><b>nsswitch.conf</b> &#x2014; файл с настройками системных баз данных (в
т.ч. порядка их просмотра) для диспетчера службы имен. Можно
указывать спецификации службы, такие как <b>files</b>, <b>ldap</b>.</li>
<li><b>/etc/ldap.conf</b> &#x2014; конфигурационный файл для <b>pam_ldap</b>.</li>
<li><b>/etc/openldap/ldap.conf</b> &#x2014; конфигурационный файл для установки
общесистемных настроек ldap-клиентов.</li>
<li><b>system-auth</b> &#x2014; назначением этого файла является
обеспечение общей конфигурации для всех приложений и сервисов,
вызывающих библиотеку PAM.</li>
<li><b>libuser.conf</b> &#x2014; файл с настройками стандартизованного интерфейса
для управления и администрирования аккаунтов пользователей и групп.</li>
<li><b>nscd.conf</b> &#x2014; конфигурационный файл демона кеша сервиса имен.</li>
</ul>

<div class="org-src-container">
<label class="org-src-name">Список измененных файлов для <b>5/2.3</b></label>
<pre class="src src-diff"><span style="color: #93a1a1;">/etc/group</span>
<span style="color: #93a1a1;">/etc/group-</span>
<span style="color: #93a1a1;">/etc/gshadow</span>
<span style="color: #93a1a1;">/etc/ldap.conf</span>
<span style="color: #93a1a1;">/etc/libuser.conf</span>
<span style="color: #93a1a1;">/etc/nscd.conf</span>
<span style="color: #93a1a1;">/etc/nsswitch.conf</span>
<span style="color: #93a1a1;">/etc/openldap/ldap.conf</span>
<span style="color: #93a1a1;">/etc/pam.d/system-auth</span>
<span style="color: #93a1a1;">/etc/pam.d/system-auth-ac</span>
<span style="color: #93a1a1;">/etc/passwd</span>
<span style="color: #93a1a1;">/etc/passwd-</span>
<span style="color: #93a1a1;">/etc/shadow</span>
<span style="color: #93a1a1;">/etc/sysconfig/authconfig</span>
</pre>
</div>

<p>
Здесь в файлах <b>group</b>, <b>group-</b>, <b>gshadow</b>, <b>shadow</b>, <b>passwd-</b>,
<b>passwd</b> &#x2014; несущественные изменения, связанные с опциями
<b>enableshadow</b> и <b>enableldap</b>; <b>system-auth-ac</b> и <b>system-auth</b> это
один и тот же файл; файл <b>authconfig</b> содержит все опции, указанные
при конфигурировании.
</p>

<p>
Для <b>6/2.4</b>, кроме файлов <b>nsswitch.conf</b>,
<b>/etc/openldap/ldap.conf</b> и <b>system-auth</b>, задействуются:
</p>

<ul class="org-ul">
<li><b>nslcd.conf</b> &#x2014; конфигурационный файл для службы сервиса имен LDAP.</li>
<li>Файлы, аналогичные <b>system-auth</b>. Они содержат только модули,
которые выполняют аутентификацию с соответствующим видом
аутентификационных токенов. Файлы <b>fingerprint-auth</b> и
<b>smartcard-auth</b> нас не интересуют, а содержимое <b>password-auth</b>
полностью идентично содержимому <b>system-auth</b>.</li>
<li><b>pam_ldap.conf</b> &#x2014; конфигурационный файл для <b>pam_ldap</b>.</li>
<li><b>sudo-ldap.conf</b> &#x2014; ldap-специфичная конфигурация для <b>sudo</b>. В
случае <b>5/2.3</b> <b>sudo</b> использует файл <b>/etc/ldap.conf</b>.</li>
</ul>

<div class="org-src-container">
<label class="org-src-name">Список измененных файлов для <b>6/2.4</b></label>
<pre class="src src-diff"><span style="color: #93a1a1;">/etc/libuser.conf</span>
<span style="color: #93a1a1;">/etc/nslcd.conf</span>
<span style="color: #93a1a1;">/etc/nsswitch.conf</span>
<span style="color: #93a1a1;">/etc/openldap/cacerts</span>
<span style="color: #93a1a1;">/etc/openldap/ldap.conf</span>
<span style="color: #93a1a1;">/etc/pam.d/fingerprint-auth</span>
<span style="color: #93a1a1;">/etc/pam.d/fingerprint-auth-ac</span>
<span style="color: #93a1a1;">/etc/pam.d/password-auth</span>
<span style="color: #93a1a1;">/etc/pam.d/password-auth-ac</span>
<span style="color: #93a1a1;">/etc/pam.d/smartcard-auth</span>
<span style="color: #93a1a1;">/etc/pam.d/smartcard-auth-ac</span>
<span style="color: #93a1a1;">/etc/pam.d/system-auth</span>
<span style="color: #93a1a1;">/etc/pam.d/system-auth-ac</span>
<span style="color: #93a1a1;">/etc/pam_ldap.conf</span>
<span style="color: #93a1a1;">/etc/sudo-ldap.conf</span>
<span style="color: #93a1a1;">/etc/sysconfig/authconfig</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-orgheadline17" class="outline-3">
<h3 id="client-options"><a id="orgheadline17"></a><a id="ID-a8dfad56-906c-45b6-9ef1-7d5a9cfa854f"></a><span class="section-number-3">2.4</span> Описание опций</h3>
<div class="outline-text-3" id="text-client-options">
</div>

<div id="outline-container-orgheadline12" class="outline-4">
<h4 id="orgheadline12"><a id="ID-2cffdc55-f975-415c-a4df-0b8ba3dab1b7"></a><span class="section-number-4">2.4.1</span> Опции, связанные с conf-файлами для <b>5/2.3</b></h4>
<div class="outline-text-4" id="text-2-4-1">
<p>
Файл <b>/etc/ldap.conf</b>. Параметр <b>host</b> не рекомендуется к использованию,
используется параметр <b>uri</b>, который указывает адрес LDAP сервера и
протокол, по которому осуществляется взаимодействие. Остальные
параметры понятны: SSL не используется, ожидается <b>md5</b> шифрование для
паролей в PAM.
</p>

<p>
Файл <b>nsswitch.conf</b>. Для баз данных <b>passwd</b>, <b>shadow</b>, <b>group</b>,
<b>netgroup</b> и <b>automount</b> добавляется спецификация службы <b>ldap</b>.
</p>
<div class="org-src-container">
<label class="org-src-name">Опции, выставляемые в файлах <b>/etc/ldap.conf</b>, <b>libuser.conf</b>  для <b>5/2.3</b> (а)</label>
<pre class="src src-diff"><span style="color: #93a1a1;">/etc/ldap.conf</span>
<span style="background-color: #fdf6e3;">17c17</span>
<span style="color: #dc322f;">&lt;</span><span style="color: #dc322f;"> host 127.0.0.1</span>
<span style="background-color: #fdf6e3;">---</span>
<span style="color: #859900;">&gt;</span><span style="color: #859900;"> #host 127.0.0.1</span>
<span style="background-color: #fdf6e3;">20c20</span>
<span style="color: #dc322f;">&lt;</span><span style="color: #dc322f;"> base dc=example,dc=com</span>
<span style="background-color: #fdf6e3;">---</span>
<span style="color: #859900;">&gt;</span><span style="color: #859900;"> base dc=mercury,dc=febras,dc=net</span>
<span style="background-color: #fdf6e3;">295a296,303</span>
<span style="color: #859900;">&gt;</span><span style="color: #859900;"> uri ldap://172.17.0.8/</span>
<span style="color: #859900;">&gt;</span><span style="color: #859900;"> ssl no</span>
<span style="color: #859900;">&gt;</span><span style="color: #859900;"> tls_cacertdir /etc/openldap/cacerts</span>
<span style="color: #859900;">&gt;</span><span style="color: #859900;"> pam_password md5</span>
<span style="color: #859900;">&gt;</span><span style="color: #859900;"> sudoers_base dc=mercury,dc=febras,dc=net</span>
<span style="color: #859900;">&gt;</span><span style="color: #859900;"> sudoers_debug 0</span>
<span style="color: #859900;">&gt;</span><span style="color: #859900;"> binddn uid=authenticator,ou=system,dc=mercury,dc=febras,dc=net</span>
<span style="color: #859900;">&gt;</span><span style="color: #859900;"> bindpw secret</span>
<span style="color: #93a1a1;">/etc/libuser.conf</span>
<span style="background-color: #fdf6e3;">21,22c21,22</span>
<span style="color: #dc322f;">&lt;</span><span style="color: #dc322f;"> modules = files shadow</span>
<span style="color: #dc322f;">&lt;</span><span style="color: #dc322f;"> create_modules = files shadow</span>
<span style="background-color: #fdf6e3;">---</span>
<span style="color: #859900;">&gt;</span><span style="color: #859900;"> modules = files shadow ldap</span>
<span style="color: #859900;">&gt;</span><span style="color: #859900;"> create_modules = ldap files shadow</span>
<span style="background-color: #fdf6e3;">64,65c64,65</span>
<span style="color: #dc322f;">&lt;</span><span style="color: #dc322f;"> # server = ldap</span>
<span style="color: #dc322f;">&lt;</span><span style="color: #dc322f;"> # basedn = dc=example,dc=com</span>
<span style="background-color: #fdf6e3;">---</span>
<span style="color: #859900;">&gt;</span><span style="color: #859900;"> server = ldap://172.17.0.8</span>
<span style="color: #859900;">&gt;</span><span style="color: #859900;"> basedn = dc=mercury,dc=febras,dc=net</span>
<span style="background-color: #fdf6e3;">68,69c68,69</span>
<span style="color: #dc322f;">&lt;</span><span style="color: #dc322f;"> # userBranch = ou=People</span>
<span style="color: #dc322f;">&lt;</span><span style="color: #dc322f;"> # groupBranch = ou=Group</span>
<span style="background-color: #fdf6e3;">---</span>
<span style="color: #859900;">&gt;</span><span style="color: #859900;"> userBranch = ou=users</span>
<span style="color: #859900;">&gt;</span><span style="color: #859900;"> groupBranch = ou=groups</span>
<span style="background-color: #fdf6e3;">73c73</span>
<span style="color: #dc322f;">&lt;</span><span style="color: #dc322f;"> # binddn = cn=Manager,dc=example,dc=com</span>
<span style="background-color: #fdf6e3;">---</span>
<span style="color: #859900;">&gt;</span><span style="color: #859900;"> binddn = cn=Manager,dc=mercury,dc=febras,dc=net</span>
</pre>
</div>

<div class="org-src-container">
<label class="org-src-name">Опции, выставляемые в файлах <b>nscd.conf</b>, <b>nsswitch.conf</b>, <b>/etc/openldap/ldap.conf</b> для <b>5/2.3</b> (б)</label>
<pre class="src src-diff"><span style="color: #93a1a1;">/etc/nscd.conf</span>
<span style="background-color: #fdf6e3;">44,45c44,45</span>
<span style="color: #dc322f;">&lt;</span><span style="color: #dc322f;">       positive-time-to-live   passwd          600</span>
<span style="color: #dc322f;">&lt;</span><span style="color: #dc322f;">       negative-time-to-live   passwd          20</span>
<span style="background-color: #fdf6e3;">---</span>
<span style="color: #859900;">&gt;</span><span style="color: #859900;">       positive-time-to-live   passwd          0</span>
<span style="color: #859900;">&gt;</span><span style="color: #859900;">       negative-time-to-live   passwd          0</span>
<span style="color: #93a1a1;">/etc/nsswitch.conf</span>
<span style="background-color: #fdf6e3;">33,35c33,35</span>
<span style="color: #dc322f;">&lt;</span><span style="color: #dc322f;"> passwd:     files</span>
<span style="color: #dc322f;">&lt;</span><span style="color: #dc322f;"> shadow:     files</span>
<span style="color: #dc322f;">&lt;</span><span style="color: #dc322f;"> group:      files</span>
<span style="background-color: #fdf6e3;">---</span>
<span style="color: #859900;">&gt;</span><span style="color: #859900;"> passwd:     files ldap</span>
<span style="color: #859900;">&gt;</span><span style="color: #859900;"> shadow:     files ldap</span>
<span style="color: #859900;">&gt;</span><span style="color: #859900;"> group:      files ldap</span>
<span style="background-color: #fdf6e3;">57c57</span>
<span style="color: #dc322f;">&lt;</span><span style="color: #dc322f;"> netgroup:   nisplus</span>
<span style="background-color: #fdf6e3;">---</span>
<span style="color: #859900;">&gt;</span><span style="color: #859900;"> netgroup:   files ldap</span>
<span style="background-color: #fdf6e3;">61c61</span>
<span style="color: #dc322f;">&lt;</span><span style="color: #dc322f;"> automount:  files nisplus</span>
<span style="background-color: #fdf6e3;">---</span>
<span style="color: #859900;">&gt;</span><span style="color: #859900;"> automount:  files ldap</span>
<span style="color: #93a1a1;">/etc/openldap/ldap.conf</span>
<span style="background-color: #fdf6e3;">13a14,16</span>
<span style="color: #859900;">&gt;</span><span style="color: #859900;"> URI ldap://172.17.0.8/</span>
<span style="color: #859900;">&gt;</span><span style="color: #859900;"> BASE dc=mercury,dc=febras,dc=net</span>
<span style="color: #859900;">&gt;</span><span style="color: #859900;"> TLS_CACERTDIR /etc/openldap/cacerts</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-orgheadline13" class="outline-4">
<h4 id="orgheadline13"><a id="ID-0c82d86b-ddc5-43c1-b4ea-a58af035d923"></a><span class="section-number-4">2.4.2</span> Опции, связанные с файлом system-auth для <b>5/2.3</b></h4>
<div class="outline-text-4" id="text-2-4-2">
<div class="org-src-container">
<label class="org-src-name">Опции, выставляемые в файле <b>system-auth</b> для <b>5/2.3</b></label>
<pre class="src src-diff"><span style="color: #93a1a1;">/etc/pam.d/system-auth</span>
<span style="background-color: #fdf6e3;">5c5,7</span>
<span style="color: #dc322f;">&lt;</span><span style="color: #dc322f;"> auth        sufficient    pam_unix.so try_first_pass nullok</span>
<span style="background-color: #fdf6e3;">---</span>
<span style="color: #859900;">&gt;</span><span style="color: #859900;"> auth        sufficient    pam_unix.so nullok try_first_pass</span>
<span style="color: #859900;">&gt;</span><span style="color: #859900;"> auth        requisite     pam_succeed_if.so uid &gt;= 500 quiet</span>
<span style="color: #859900;">&gt;</span><span style="color: #859900;"> auth        sufficient    pam_ldap.so use_first_pass</span>
<span style="background-color: #fdf6e3;">8c10,13</span>
<span style="color: #dc322f;">&lt;</span><span style="color: #dc322f;"> account     required      pam_unix.so</span>
<span style="background-color: #fdf6e3;">---</span>
<span style="color: #859900;">&gt;</span><span style="color: #859900;"> account     required      pam_unix.so broken_shadow</span>
<span style="color: #859900;">&gt;</span><span style="color: #859900;"> account     sufficient    pam_succeed_if.so uid &lt; 500 quiet</span>
<span style="color: #859900;">&gt;</span><span style="color: #859900;"> account     [default=bad success=ok user_unknown=ignore] pam_ldap.so</span>
<span style="color: #859900;">&gt;</span><span style="color: #859900;"> account     required      pam_permit.so</span>
<span style="background-color: #fdf6e3;">10,11c15,17</span>
<span style="color: #dc322f;">&lt;</span><span style="color: #dc322f;"> password    required      pam_cracklib.so try_first_pass retry=3</span>
<span style="color: #dc322f;">&lt;</span><span style="color: #dc322f;"> password    sufficient    pam_unix.so try_first_pass use_authtok nullok md5</span>
<span style="background-color: #fdf6e3;">---</span>
<span style="color: #859900;">&gt;</span><span style="color: #859900;"> password    requisite     pam_cracklib.so try_first_pass retry=3</span>
<span style="color: #859900;">&gt;</span><span style="color: #859900;"> password    sufficient    pam_unix.so md5 shadow nullok try_first_pass use_authtok</span>
<span style="color: #859900;">&gt;</span><span style="color: #859900;"> password    sufficient    pam_ldap.so use_authtok</span>
<span style="background-color: #fdf6e3;">15a22</span>
<span style="color: #859900;">&gt;</span><span style="color: #859900;"> session     optional      pam_mkhomedir.so skel=/etc/skel umask=0077</span>
<span style="background-color: #fdf6e3;">17a25</span>
<span style="color: #859900;">&gt;</span><span style="color: #859900;"> session     optional      pam_ldap.so</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-orgheadline14" class="outline-4">
<h4 id="orgheadline14"><a id="ID-bffd7a17-e40c-4550-92d4-2d4ece369ca3"></a><span class="section-number-4">2.4.3</span> Опции, связанные с conf-файлами для <b>6/2.4</b></h4>
<div class="outline-text-4" id="text-2-4-3">
<p>
В файлах <b>nslcd.conf</b>, <b>pam_ldap.conf</b> и <b>sudo-ldap.conf</b> дублируются
стандартные опции.
</p>

<div class="org-src-container">
<label class="org-src-name">Опции, выставляемые в файлах <b>libuser.conf</b>, <b>nslcd.conf</b>, <b>nsswitch.conf</b> и <b>/etc/openldap/ldap.conf</b> для <b>6/2.4</b></label>
<pre class="src src-diff"><span style="color: #93a1a1;">/etc/libuser.conf</span>
<span style="background-color: #fdf6e3;">21,22c21,22</span>
<span style="color: #dc322f;">&lt;</span><span style="color: #dc322f;"> modules = files shadow</span>
<span style="color: #dc322f;">&lt;</span><span style="color: #dc322f;"> create_modules = files shadow</span>
<span style="background-color: #fdf6e3;">---</span>
<span style="color: #859900;">&gt;</span><span style="color: #859900;"> modules = files shadow ldap</span>
<span style="color: #859900;">&gt;</span><span style="color: #859900;"> create_modules = ldap files shadow</span>
<span style="background-color: #fdf6e3;">64,65c64,65</span>
<span style="color: #dc322f;">&lt;</span><span style="color: #dc322f;"> # server = ldap</span>
<span style="color: #dc322f;">&lt;</span><span style="color: #dc322f;"> # basedn = dc=example,dc=com</span>
<span style="background-color: #fdf6e3;">---</span>
<span style="color: #859900;">&gt;</span><span style="color: #859900;"> server = ldap://172.17.0.5</span>
<span style="color: #859900;">&gt;</span><span style="color: #859900;"> basedn = dc=mercury,dc=febras,dc=net</span>
<span style="background-color: #fdf6e3;">68,69c68,69</span>
<span style="color: #dc322f;">&lt;</span><span style="color: #dc322f;"> # userBranch = ou=People</span>
<span style="color: #dc322f;">&lt;</span><span style="color: #dc322f;"> # groupBranch = ou=Group</span>
<span style="background-color: #fdf6e3;">---</span>
<span style="color: #859900;">&gt;</span><span style="color: #859900;"> userBranch = ou=users</span>
<span style="color: #859900;">&gt;</span><span style="color: #859900;"> groupBranch = ou=groups</span>
<span style="background-color: #fdf6e3;">73c73</span>
<span style="color: #dc322f;">&lt;</span><span style="color: #dc322f;"> # binddn = cn=Manager,dc=example,dc=com</span>
<span style="background-color: #fdf6e3;">---</span>
<span style="color: #859900;">&gt;</span><span style="color: #859900;"> binddn = cn=Manager,dc=mercury,dc=febras,dc=net</span>
<span style="color: #93a1a1;">/etc/nslcd.conf</span>
<span style="background-color: #fdf6e3;">131,132c131,136</span>
<span style="color: #dc322f;">&lt;</span><span style="color: #dc322f;"> uri ldap://127.0.0.1/</span>
<span style="color: #dc322f;">&lt;</span><span style="color: #dc322f;"> base dc=example,dc=com</span>
<span style="background-color: #fdf6e3;">---</span>
<span style="color: #859900;">&gt;</span><span style="color: #859900;"> uri ldap://172.17.0.5/</span>
<span style="color: #859900;">&gt;</span><span style="color: #859900;"> base dc=mercury,dc=febras,dc=net</span>
<span style="color: #859900;">&gt;</span><span style="color: #859900;"> ssl no</span>
<span style="color: #859900;">&gt;</span><span style="color: #859900;"> tls_cacertdir /etc/openldap/cacerts</span>
<span style="color: #859900;">&gt;</span><span style="color: #859900;"> binddn uid=authenticator,ou=system,dc=mercury,dc=febras,dc=net</span>
<span style="color: #859900;">&gt;</span><span style="color: #859900;"> bindpw secret</span>
<span style="color: #93a1a1;">/etc/nsswitch.conf</span>
<span style="background-color: #fdf6e3;">33,35c33,35</span>
<span style="color: #dc322f;">&lt;</span><span style="color: #dc322f;"> passwd:     files</span>
<span style="color: #dc322f;">&lt;</span><span style="color: #dc322f;"> shadow:     files</span>
<span style="color: #dc322f;">&lt;</span><span style="color: #dc322f;"> group:      files</span>
<span style="background-color: #fdf6e3;">---</span>
<span style="color: #859900;">&gt;</span><span style="color: #859900;"> passwd:     files ldap</span>
<span style="color: #859900;">&gt;</span><span style="color: #859900;"> shadow:     files ldap</span>
<span style="color: #859900;">&gt;</span><span style="color: #859900;"> group:      files ldap</span>
<span style="background-color: #fdf6e3;">57c57</span>
<span style="color: #dc322f;">&lt;</span><span style="color: #dc322f;"> netgroup:   nisplus</span>
<span style="background-color: #fdf6e3;">---</span>
<span style="color: #859900;">&gt;</span><span style="color: #859900;"> netgroup:   files ldap</span>
<span style="background-color: #fdf6e3;">61c61</span>
<span style="color: #dc322f;">&lt;</span><span style="color: #dc322f;"> automount:  files nisplus</span>
<span style="background-color: #fdf6e3;">---</span>
<span style="color: #859900;">&gt;</span><span style="color: #859900;"> automount:  files ldap</span>
<span style="background-color: #fdf6e3;">63a64</span>
<span style="color: #859900;">&gt;</span><span style="color: #859900;"> sudoers: files ldap</span>
<span style="color: #93a1a1;">/etc/openldap/ldap.conf</span>
<span style="background-color: #fdf6e3;">15c15,17</span>
<span style="color: #dc322f;">&lt;</span><span style="color: #dc322f;"> TLS_CACERTDIR /etc/openldap/certs</span>
<span style="background-color: #fdf6e3;">---</span>
<span style="color: #859900;">&gt;</span><span style="color: #859900;"> TLS_CACERTDIR /etc/openldap/cacerts</span>
<span style="color: #859900;">&gt;</span><span style="color: #859900;"> URI ldap://172.17.0.5/</span>
<span style="color: #859900;">&gt;</span><span style="color: #859900;"> BASE dc=mercury,dc=febras,dc=net</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-orgheadline15" class="outline-4">
<h4 id="orgheadline15"><a id="ID-5bedb39f-f4fd-416b-9c11-ebba1119ac1a"></a><span class="section-number-4">2.4.4</span> Опции, связанные с файлом system-auth для <b>6/2.4</b></h4>
<div class="outline-text-4" id="text-2-4-4">
<div class="org-src-container">
<label class="org-src-name">Опции, выставляемые файлах <b>system-auth</b>, <b>pam_ldap.conf</b> и <b>sudo-ldap.conf</b> для <b>6/2.4</b></label>
<pre class="src src-diff"><span style="color: #93a1a1;">/etc/pam.d/system-auth</span>
<span style="background-color: #fdf6e3;">5c5,7</span>
<span style="color: #dc322f;">&lt;</span><span style="color: #dc322f;"> auth        sufficient    pam_unix.so try_first_pass nullok</span>
<span style="background-color: #fdf6e3;">---</span>
<span style="color: #859900;">&gt;</span><span style="color: #859900;"> auth        sufficient    pam_unix.so nullok try_first_pass</span>
<span style="color: #859900;">&gt;</span><span style="color: #859900;"> auth        requisite     pam_succeed_if.so uid &gt;= 500 quiet</span>
<span style="color: #859900;">&gt;</span><span style="color: #859900;"> auth        sufficient    pam_ldap.so use_first_pass</span>
<span style="background-color: #fdf6e3;">8c10,14</span>
<span style="color: #dc322f;">&lt;</span><span style="color: #dc322f;"> account     required      pam_unix.so</span>
<span style="background-color: #fdf6e3;">---</span>
<span style="color: #859900;">&gt;</span><span style="color: #859900;"> account     required      pam_unix.so broken_shadow</span>
<span style="color: #859900;">&gt;</span><span style="color: #859900;"> account     sufficient    pam_localuser.so</span>
<span style="color: #859900;">&gt;</span><span style="color: #859900;"> account     sufficient    pam_succeed_if.so uid &lt; 500 quiet</span>
<span style="color: #859900;">&gt;</span><span style="color: #859900;"> account     [default=bad success=ok user_unknown=ignore] pam_ldap.so</span>
<span style="color: #859900;">&gt;</span><span style="color: #859900;"> account     required      pam_permit.so</span>
<span style="background-color: #fdf6e3;">11c17,18</span>
<span style="color: #dc322f;">&lt;</span><span style="color: #dc322f;"> password    sufficient    pam_unix.so try_first_pass use_authtok nullok sha512 shadow</span>
<span style="background-color: #fdf6e3;">---</span>
<span style="color: #859900;">&gt;</span><span style="color: #859900;"> password    sufficient    pam_unix.so sha512 shadow nullok try_first_pass use_authtok</span>
<span style="color: #859900;">&gt;</span><span style="color: #859900;"> password    sufficient    pam_ldap.so use_authtok</span>
<span style="background-color: #fdf6e3;">15a23</span>
<span style="color: #859900;">&gt;</span><span style="color: #859900;"> session     optional      pam_mkhomedir.so umask=0077</span>
<span style="background-color: #fdf6e3;">17a26</span>
<span style="color: #859900;">&gt;</span><span style="color: #859900;"> session     optional      pam_ldap.so</span>
<span style="color: #93a1a1;">/etc/pam_ldap.conf</span>
<span style="background-color: #fdf6e3;">17c17</span>
<span style="color: #dc322f;">&lt;</span><span style="color: #dc322f;"> host 127.0.0.1</span>
<span style="background-color: #fdf6e3;">---</span>
<span style="color: #859900;">&gt;</span><span style="color: #859900;"> #host 127.0.0.1</span>
<span style="background-color: #fdf6e3;">20c20</span>
<span style="color: #dc322f;">&lt;</span><span style="color: #dc322f;"> base dc=example,dc=com</span>
<span style="background-color: #fdf6e3;">---</span>
<span style="color: #859900;">&gt;</span><span style="color: #859900;"> base dc=mercury,dc=febras,dc=net</span>
<span style="background-color: #fdf6e3;">289a290,295</span>
<span style="color: #859900;">&gt;</span><span style="color: #859900;"> uri ldap://172.17.0.5/</span>
<span style="color: #859900;">&gt;</span><span style="color: #859900;"> ssl no</span>
<span style="color: #859900;">&gt;</span><span style="color: #859900;"> tls_cacertdir /etc/openldap/cacerts</span>
<span style="color: #859900;">&gt;</span><span style="color: #859900;"> pam_password md5</span>
<span style="color: #859900;">&gt;</span><span style="color: #859900;"> binddn uid=authenticator,ou=system,dc=mercury,dc=febras,dc=net</span>
<span style="color: #859900;">&gt;</span><span style="color: #859900;"> bindpw secret</span>
<span style="color: #93a1a1;">/etc/sudo-ldap.conf</span>
<span style="background-color: #fdf6e3;">86a87,92</span>
<span style="color: #859900;">&gt;</span><span style="color: #859900;"> uri ldap://172.17.0.5/</span>
<span style="color: #859900;">&gt;</span><span style="color: #859900;"> base dc=mercury,dc=febras,dc=net</span>
<span style="color: #859900;">&gt;</span><span style="color: #859900;"> sudoers_base dc=mercury,dc=febras,dc=net</span>
<span style="color: #859900;">&gt;</span><span style="color: #859900;"> sudoers_debug 0</span>
<span style="color: #859900;">&gt;</span><span style="color: #859900;"> binddn uid=authenticator,ou=system,dc=mercury,dc=febras,dc=net</span>
<span style="color: #859900;">&gt;</span><span style="color: #859900;"> bindpw secret</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-orgheadline16" class="outline-4">
<h4 id="orgheadline16"><a id="ID-e8f37bcc-b065-41f2-9398-80816656d325"></a><span class="section-number-4">2.4.5</span> Дополнительно. PAM: необходимые сведения</h4>
<div class="outline-text-4" id="text-2-4-5">
<p>
Утилита <b>authconfig</b> осуществляет необходимую модификацию PAM
(Pluggable Authentication Modules), добавляя библиотеку <b>pam_ldap.so</b>
и дополнительные настройки, обеспечивающие поддержку механизма
аутентификации средствами LDAP. PAM &#x2014; это стандартный интерфейс,
который может работать как с локальной базой данных <b>files</b>, так и c
базой <b>ldap</b>.
</p>

<p>
С точки зрения PAM, аутентификация состоит из нескольких независимых задач<sup><a id="fnr.5" class="footref" href="#fn.5">5</a></sup>:
</p>
<ul class="org-ul">
<li><b>account</b> (управление учетными записями) &#x2014; описывает службу
проверки учетной записи, которая отвечает на вопросы: "есть ли
такая запись и не истек ли срок действия пароля?", "имеет ли
пользователь право доступа к запрошенному ресурсу?"</li>
<li><b>auth</b> (управление аутентификацией) &#x2014; описывает службу проверки
идентичности пользователя. Эта служба реализована посредством
диалога между пользователем и программой аутентификации: "как тебя
зовут и какой у тебя пароль?".</li>
<li><b>password</b> (управление паролями) &#x2014; описывает службу изменения
пароля; такая служба должна быть тесно связана со службой проверки
учетной записи. Например, по истечении срока действия пароля
система требует у пользователя новый пароль.</li>
<li><b>session</b> (управление сессиями) &#x2014; описывает работы, которые
должны быть выполнены до того, как ресурс будет предоставлен, или
после того, как он будет освобожден (например, после разрыва
соединения между программой-клиентом и вызванной им
службой-сервером). Скажем, это может быть протоколирование начала
и конца соединения, монтирование домашнего каталога пользователя и
т.п.</li>
</ul>

<p>
Определение поведения PAM в случае, если модуль примет решение об
отказе в аутентификации (допустим, сочтет пароль неверным). Возможные
варианты действий:
</p>
<ul class="org-ul">
<li><b>requisite</b> &#x2014; отказ приводит к немедленному прекращению аутентификации;</li>
<li><b>required</b> &#x2014; отказ приводит к тому, что PAM API возвращает ошибку,
но только после того, как будут вызваны все оставшиеся в стеке
модули (для этого приложения);</li>
<li><b>sufficient</b> &#x2014; успешная аутентификация достаточна для
удовлетворения требований по аутентификации стека модулей (если
предыдущий модуль в стеке выдал отказ в аутентификации, то успех
аутентификации текущего модуля игнорируется);</li>
<li><b>optional</b> &#x2014; успех или отказ в аутентификации с использованием
данного модуля имеет значение, только если это единственный модуль в
стеке, ассоциированном с данным приложением и типом аутентификации
(т.е. нет других <b>optional</b> модулей).</li>
</ul>
</div>
</div>
</div>
</div>

<div id="outline-container-orgheadline24" class="outline-2">
<h2 id="schema"><a id="orgheadline24"></a><a id="ID-b64d7c36-b2b3-49ac-9620-d7c94eb9ea31"></a><span class="section-number-2">3</span> Схема каталога LDAP</h2>
<div class="outline-text-2" id="text-schema">
<blockquote>
<p>
Необходимо разработать схему каталога LDAP, предназначенную для хранения учетных данных пользователей кластера.
</p>
</blockquote>

<p>
Использование только <b>ldif</b> формата позволяет единообразно
конфигурировать схему каталога LDAP, начиная с корневой записи DIT
(Directory Information Tree) <b>cn=config</b>, включающей точку ветвления
<b>cn=schema,cn=config</b>, которая содержит наборы схем данных
(см. подраздел <a href="#configure-slapd">1.6</a>), переходя к корневой записи домена
(см. подраздел <a href="#root-domain">3.3</a>) и заканчивая листьями этого дерева
(см. подразделы <a href="#new-user-ldap">4.1</a>, <a href="#add-users">4.5</a>) &#x2014; записями, содержащими
нужную информацию:
</p>
<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<tbody>
<tr>
<td class="org-left"><b>slapd.ldif</b></td>
<td class="org-left">формирование корневой записи DIT и контейнера для наборов схем данных; конфигурирование базы данных <b>HDB</b>, подключение мониторинга баз данных и загрузка модуля <b>ppolicy</b></td>
</tr>

<tr>
<td class="org-left"><b>front.ldif</b></td>
<td class="org-left">добавление служебной базы данных <b>frontend</b> (только для <b>5/2.3</b>)</td>
</tr>

<tr>
<td class="org-left"><b>domain.ldif</b></td>
<td class="org-left">связывание суффикса, менеджера домена и его пароля с базой <b>HDB</b>; установка списка контроля доступа ACL  и привязка модуля <b>ppolicy</b> к <b>passwordDefault</b></td>
</tr>

<tr>
<td class="org-left"><b>base.ldif</b></td>
<td class="org-left">создание суффикса, менеджера домена, организационных единиц, учетной записи <b>authenticator</b> и настроек <b>passwordDefaults</b></td>
</tr>

<tr>
<td class="org-left"><b>sudoers.ldif</b></td>
<td class="org-left">создание организационной единицы <b>sudoers</b>, добавление настроек по умолчанию для <b>sudo</b> и группы <b>sudowheel</b>, включенной в группу администраторов <b>sudo</b></td>
</tr>

<tr>
<td class="org-left"><b>user.ldif</b></td>
<td class="org-left">создание нового пользователя, принадлежащего к группе <b>sudowheel</b></td>
</tr>

<tr>
<td class="org-left"><b>mercury.ldif</b></td>
<td class="org-left">пример результата миграции пользователей и групп с помощью утилит <b>migrationtools</b></td>
</tr>
</tbody>
</table>

<p>
Если же используется <b>conf</b> формат, то надо иметь в виду, что
первый файл из этого ряда конфигурационных файлов
заменяется на <b>slapd.conf</b> (см. раздел <a href="#configure-slapd-conf">1.5</a>).
</p>

<div class="note">
<p>
В данном руководстве слово "схема" используется в выражении <i>набор
схем данных</i> (см. подраздел <a href="#add-schemas">1.3</a>), означающим файл с
расширением <b>schema</b> или <b>ldif</b>, содержащий "низкоуровневое" описание
классов, атрибутов, синтаксисов атрибута и правил соответствия. Также,
оно используется в выражении <i>схема каталога LDAP</i>, т.е. для
"высокоуровнего" описания содержания, структуры и ограничений
целостности каталога LDAP, по аналогии с выражением <i>схема базы
данных</i>, применимым для реляционных баз данных. Возможности схемы
каталога LDAP определяются подключенными наборами схем данных. Можно
сказать, что <i>схема каталога LDAP</i> &#x2014; это полное описание каталога
LDAP с помощью <b>ldif</b> формата. При этом, граница между схемой каталога
и пользовательскими данными, которые также хранятся в <b>ldif</b> формате,
становится условной. Кроме того, каталог LDAP использует <i>базу данных
<b>HDB</b></i> в качестве хранилища данных.
</p>

</div>

<p>
В таблице <a href="#orgtable1">2</a> приведены примеры использования классов
и атрибутов схемы каталога LDAP. В данном разделе осуществляется
"высокоуровневая" разработка схемы каталога LDAP в <b>ldif</b> формате,
предназначенная для хранения учетных данных пользователей
кластера. Подключаются только указанные наборы схем данных,
разрабатывать дополнительные "низкоуровневые" наборы схем данных нет
необходимости.
</p>

<table id="orgtable1" border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">
<caption class="t-above"><span class="table-number">&#1058;&#1072;&#1073;&#1083;&#1080;&#1094;&#1072; 2.:</span> Примеры наборов схем данных, классов, атрибутов и их использования</caption>

<colgroup>
<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">Набор схем данных</th>
<th scope="col" class="org-left">Классы</th>
<th scope="col" class="org-left">Атрибуты</th>
<th scope="col" class="org-left">Примеры использования</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">openldap hardcoded</td>
<td class="org-left">top, olcDatabaseConfig</td>
<td class="org-left">uid, cn, olcSchemaDN</td>
<td class="org-left">slapd.ldif, domain.ldif, front.ldif</td>
</tr>

<tr>
<td class="org-left">core.schema</td>
<td class="org-left">dcObject, organizationalRole</td>
<td class="org-left">dc, sn</td>
<td class="org-left">base.ldif</td>
</tr>

<tr>
<td class="org-left">cosine.schema</td>
<td class="org-left">simpleSecurityObject, account</td>
<td class="org-left">userPassword</td>
<td class="org-left">base.ldif</td>
</tr>

<tr>
<td class="org-left">inetorgperson.schema</td>
<td class="org-left">inetOrgPerson</td>
<td class="org-left">employeeNumber</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">nis.schema</td>
<td class="org-left">posixAccount, posixGroup</td>
<td class="org-left">homeDirectory, gidNumber</td>
<td class="org-left">user.ldif, mercury.ldif</td>
</tr>

<tr>
<td class="org-left">sudo.schema</td>
<td class="org-left">sudoRole</td>
<td class="org-left">sudoUser</td>
<td class="org-left">sudoers.ldif</td>
</tr>

<tr>
<td class="org-left">misc.schema</td>
<td class="org-left">inetLocalMailRecipient</td>
<td class="org-left">mailRoutingAddress</td>
<td class="org-left">user.ldif</td>
</tr>

<tr>
<td class="org-left">ppolicy.schema</td>
<td class="org-left">pwdPolicy</td>
<td class="org-left">pwdAttribute</td>
<td class="org-left">base.ldif</td>
</tr>
</tbody>
</table>
</div>



<div id="outline-container-orgheadline19" class="outline-3">
<h3 id="minimal-schema"><a id="orgheadline19"></a><a id="ID-3446a07c-3649-4e85-84c1-044e78c340dc"></a><span class="section-number-3">3.1</span> Настройка каталога LDAP</h3>
<div class="outline-text-3" id="text-minimal-schema">
<p class="verse">
Где работаем: контейнеры <b>server-&#x2026;..</b><br  />
</p>

<p>
В разделе <a href="#authentication">2</a> перечислены три задачи, возникающие при
настройке аутентификации пользователей при помощи LDAP, и
продемонстрирована реализация клиентской части. Серверная часть &#x2014;
каталог LDAP &#x2014; должна обеспечивать поддержку данной
функциональности. Нам потребуются контейнеры для хранения учетных
данных пользователей и групп. Разрешим доступ к данным пользователей
только для клиентских систем со специальной учетной записью, запретим
анонимный доступ. Добавим тип учетных записей пользователей,
обладающих разрешениями <b>sudo</b>.
</p>

<p>
Чтобы получить минимально работоспособный сервер LDAP, позволяющий
осуществлять аутентификацию для клиентских систем, внесем необходимые
изменения в схему каталога.
</p>

<div class="org-src-container">

<pre class="src src-sh"><span style="color: #657b83; font-weight: bold;">cd</span> /schema

cp domain.ldif domain+.ldif
<span style="color: #268bd2;">MANAGER_PWD</span>=$(<span style="color: #6c71c4; font-weight: bold;">slappasswd</span> -s $<span style="color: #268bd2;">LDAP_MANAGER_PASSWORD</span>)
<span style="color: #93a1a1;"># </span><span style="color: #93a1a1;">Use bash variable substitution to escape special chars http://stackoverflow.com/a/14339705</span>
sed -i <span style="color: #2aa198;">"s+%LDAP_MANAGER_PASSWORD%+${MANAGER_PWD//+/\\+}+"</span> domain+.ldif
ldapmodify -v -D <span style="color: #268bd2;">cn</span>=Manager,<span style="color: #268bd2;">cn</span>=config -f domain+.ldif -x -w $<span style="color: #268bd2;">LDAP_ROOT_PASSWORD</span>
rm domain+.ldif
ldapadd -x -D <span style="color: #2aa198;">'cn=Manager,dc=mercury,dc=febras,dc=net'</span> -w $<span style="color: #268bd2;">LDAP_MANAGER_PASSWORD</span> -f base.ldif
ldapadd -x -D <span style="color: #2aa198;">'cn=Manager,dc=mercury,dc=febras,dc=net'</span> -w $<span style="color: #268bd2;">LDAP_MANAGER_PASSWORD</span> -f sudoers.ldif
</pre>
</div>
</div>
</div>

<div id="outline-container-orgheadline20" class="outline-3">
<h3 id="hdb-domain-config"><a id="orgheadline20"></a><a id="ID-d8a0d9fc-cb9b-46c3-b6f8-abd2f6766517"></a><span class="section-number-3">3.2</span> Связывание базы данных HDB с доменом и настройка ACL</h3>
<div class="outline-text-3" id="text-hdb-domain-config">
<p>
В подразделе <a href="#configure-hdb">1.2</a> была подготовлена база данных
<b>HDB</b>. Сконфигурируем (см. расп. <a href="#orgsrcblock3">31</a>) её для доменного имени
<b>dc=mercury,dc=febras,dc=net</b>, определим менеджера домена
<b>cn=Manager,dc=mercury,dc=febras,dc=net</b> и его пароль. Также, добавим
правила доступа к атрибуту <b>userPassword</b> (см. подраздел
<a href="#new-user-ldap">4.1</a>): для владельца записи &#x2014; <i>write</i> и для
неавторизованного пользователя &#x2014; <i>auth</i>. Для атрибута
<b>shadowLastChange</b>: владелец и пользователь <b>authentificator</b> имеют право на запись
<i>write</i>. Анонимный доступ будет разрешен только для заголовочной части
записи подразделения <b>public</b> и для ее содержимого. Ко всем
остальным объектам в базе применяется правило доступа для пользователя
<b>authentificator</b> &#x2014; <i>read</i>.
</p>

<p>
Учетные записи из подразделения <b>users</b> могут считываться модулем PAM
из БД LDAP для осуществления аутентификации про входе в систему на
клиентских машинах, но они не могут (в нынешней конфигурации)
применяться для аутентификации в самой БД LDAP. Поэтому, чтобы не
предоставлять анонимный доступ к данным БД LDAP, применяется учетная
запись <b>authenticator</b>, которую модуль PAM использует для работы с БД
LDAP. В нашем случае, доступ к большей части информации на сервере
каталогов (кроме подразделения <b>public</b> для анонимного доступа) имеют
только те компьютеры, на которых в качестве <b>binddn</b> присутствует
учетная запись <b>authenticator</b> (см. подраздел <a href="#client-commands">2.2</a>).
</p>

<div class="note">
<p>
Учетная запись <b>authenticator</b> добавляет дополнительный уровень
безопасности после анонимного доступа.
</p>

</div>

<p>
Текущую политику контроля доступа для БД (ACL) можно описать следущими
словами: она состоит из четырех правил, первые два из них определяют
права для атрибутов <b>userPassword</b> и <b>shadowLastChange</b>, которые
следуют из необходимости осуществления изменения пароля, сохранения
даты его изменения и проведения авторизации. Третье правило
несущественно. Четвертое правило разрешает доступ ко всем атрибутам
пользователю <b>authenticator</b>.
</p>

<div class="org-src-container">
<label class="org-src-name"><b>domain.ldif</b>: связывание суффикса, менеджера домена и его пароля с базой <b>HDB</b>; установка списка контроля доступа ACL  и привязка модуля <b>ppolicy</b> к <b>passwordDefault</b></label>
<pre class="src src-ldif" id="orgsrcblock3"><span style="color: #859900; font-weight: bold;">dn</span>: <span style="color: #268bd2;">olcDatabase={2}hdb,cn=config</span>
<span style="color: #859900; font-weight: bold;">changetype</span>: <span style="color: #268bd2; font-weight: bold;">modify</span>
<span style="color: #859900; font-weight: bold;">replace</span>: <span style="color: #268bd2;">olcSuffix</span>
olcSuffix: dc=mercury,dc=febras,dc=net

<span style="color: #859900; font-weight: bold;">dn</span>: <span style="color: #268bd2;">olcDatabase={2}hdb,cn=config</span>
<span style="color: #859900; font-weight: bold;">changetype</span>: <span style="color: #268bd2; font-weight: bold;">modify</span>
<span style="color: #859900; font-weight: bold;">replace</span>: <span style="color: #268bd2;">olcRootDN</span>
olcRootDN: cn=Manager,dc=mercury,dc=febras,dc=net

<span style="color: #859900; font-weight: bold;">dn</span>: <span style="color: #268bd2;">olcDatabase={2}hdb,cn=config</span>
<span style="color: #859900; font-weight: bold;">changetype</span>: <span style="color: #268bd2; font-weight: bold;">modify</span>
<span style="color: #859900; font-weight: bold;">add</span>: <span style="color: #268bd2;">olcRootPW</span>
olcRootPW: %LDAP_MANAGER_PASSWORD%

<span style="color: #859900; font-weight: bold;">dn</span>: <span style="color: #268bd2;">olcDatabase={2}hdb,cn=config</span>
<span style="color: #859900; font-weight: bold;">add</span>: <span style="color: #268bd2;">olcAccess</span>
olcAccess: {0}to attrs=userPassword
  by self write
  by * auth
olcAccess: {1}to attrs=shadowLastChange
  by self write
  by dn="uid=authenticator,ou=system,dc=mercury,dc=febras,dc=net" read
  by dn="uid=authenticator,ou=system,dc=mercury,dc=febras,dc=net" write
olcAccess: {2}to dn.subtree="ou=public,dc=mercury,dc=febras,dc=net"
  by * read
olcAccess: {3}to *
  by dn="uid=authenticator,ou=system,dc=mercury,dc=febras,dc=net" read
  by self read
  by * none

<span style="color: #859900; font-weight: bold;">dn</span>: <span style="color: #268bd2;">olcOverlay={0}ppolicy,olcDatabase={2}hdb,cn=config</span>
<span style="color: #859900; font-weight: bold;">changetype</span>: <span style="color: #268bd2; font-weight: bold;">modify</span>
<span style="color: #859900; font-weight: bold;">replace</span>: <span style="color: #268bd2;">olcPPolicyDefault</span>
olcPPolicyDefault: cn=passwordDefault,ou=policies,dc=mercury,dc=febras,dc=net
</pre>
</div>
</div>
</div>

<div id="outline-container-orgheadline21" class="outline-3">
<h3 id="root-domain"><a id="orgheadline21"></a><a id="ID-98673b98-df88-4fb4-859f-9f8283c1346c"></a><span class="section-number-3">3.3</span> Создание корневой записи домена</h3>
<div class="outline-text-3" id="text-root-domain">
<p>
В подразделе <a href="#configure-slapd">1.6</a> было продемонстрировано создание корневой
записи дерева DIT средствами формата <b>ldif</b> (эквивалентную настройку
можно осуществить при помощи файла конфигурации <b>conf</b>, как это
показано в подразделе <a href="#configure-slapd-conf">1.5</a>). Теперь создадим корневую
запись домена, добавим необходимые атрибуты (см. расп. <a href="#orgsrcblock4">32</a>),
корневой узел <b>dn: dc=mercury,dc=febras,dc=net</b>,
подразделения <b>users</b>, <b>groups</b>, <b>system</b> и <b>public</b>, а также
пользователя <b>authenticator</b>.
</p>

<div class="org-src-container">
<label class="org-src-name"><b>base.ldif</b>: создание суффикса, менеджера домена, организационных единиц, учетной записи <b>authenticator</b> и настроек <b>passwordDefaults</b></label>
<pre class="src src-ldif" id="orgsrcblock4"><span style="color: #859900; font-weight: bold;">dn</span>: <span style="color: #268bd2;">dc=mercury,dc=febras,dc=net</span>
objectClass: top
objectClass: dcObject
objectClass: organization
dc: mercury
o: mercury

<span style="color: #859900; font-weight: bold;">dn</span>: <span style="color: #268bd2;">cn=Manager,dc=mercury,dc=febras,dc=net</span>
objectClass: organizationalRole
cn: Manager
description: Directory Manager

<span style="color: #859900; font-weight: bold;">dn</span>: <span style="color: #268bd2;">ou=public,dc=mercury,dc=febras,dc=net</span>
objectClass: organizationalUnit
ou: public

<span style="color: #859900; font-weight: bold;">dn</span>: <span style="color: #268bd2;">ou=users,dc=mercury,dc=febras,dc=net</span>
objectClass: organizationalUnit
ou: users

<span style="color: #859900; font-weight: bold;">dn</span>: <span style="color: #268bd2;">ou=groups,dc=mercury,dc=febras,dc=net</span>
objectClass: organizationalUnit
ou: groups

<span style="color: #859900; font-weight: bold;">dn</span>: <span style="color: #268bd2;">ou=system,dc=mercury,dc=febras,dc=net</span>
objectClass: organizationalUnit
ou: system

<span style="color: #859900; font-weight: bold;">dn</span>: <span style="color: #268bd2;">uid=authenticator,ou=system,dc=mercury,dc=febras,dc=net</span>
objectClass: account
objectClass: simpleSecurityObject
uid: authenticator
description: Used for authentication to LDAP
userPassword: secret

<span style="color: #859900; font-weight: bold;">dn</span>: <span style="color: #268bd2;">ou=policies,dc=mercury,dc=febras,dc=net</span>
ou: policies
objectClass: organizationalUnit

<span style="color: #859900; font-weight: bold;">dn</span>: <span style="color: #268bd2;">cn=passwordDefault,ou=policies,dc=mercury,dc=febras,dc=net</span>
objectClass: pwdPolicy
objectClass: person
objectClass: top
cn: passwordDefault
sn: passwordDefault
pwdAttribute: userPassword
</pre>
</div>
</div>
</div>

<div id="outline-container-orgheadline22" class="outline-3">
<h3 id="create-sudoers"><a id="orgheadline22"></a><a id="ID-22a6415e-716f-4045-aab4-2535b7bdff12"></a><span class="section-number-3">3.4</span> Формирование подразделения sudoers</h3>
<div class="outline-text-3" id="text-create-sudoers">
<p>
Создадим подразделение <b>sudoers</b>, одну posix-группу <b>sudowheel</b> и
сконфигурируем <b>sudoers</b> так, чтобы разрешить выполнение <b>sudo</b> команд
без ввода пароля для членов этой группы (см. расп. <a href="#orgsrcblock5">33</a>). Класс
<b>sudoRole</b> содержится в файле <b>sudo.schema</b>, подключенном в подразделе
<a href="#add-schemas">1.3</a>.
</p>

<div class="org-src-container">
<label class="org-src-name"><b>sudoers.ldif</b>: создание организационной единицы <b>sudoers</b>, добавление настроек по умолчанию для <b>sudo</b> и группы <b>sudowheel</b>, включенной в группу администраторов <b>sudo</b></label>
<pre class="src src-ldif" id="orgsrcblock5"><span style="color: #859900; font-weight: bold;">dn</span>: <span style="color: #268bd2;">ou=sudoers,dc=mercury,dc=febras,dc=net</span>
objectClass: organizationalUnit
ou: sudoers

<span style="color: #859900; font-weight: bold;">dn</span>: <span style="color: #268bd2;">cn=sudowheel,ou=groups,dc=mercury,dc=febras,dc=net</span>
cn: sudowheel
objectClass: posixGroup
objectClass: top
gidNumber: 1030
memberUid: username

<span style="color: #859900; font-weight: bold;">dn</span>: <span style="color: #268bd2;">cn=admins,ou=sudoers,dc=mercury,dc=febras,dc=net</span>
objectClass: sudoRole
objectClass: top
cn: admins
sudoCommand: ALL
sudoRunAs: ALL
sudoHost: ALL
sudoUser: %sudowheel
sudoOption: !authenticate

<span style="color: #859900; font-weight: bold;">dn</span>: <span style="color: #268bd2;">cn=defaults,ou=sudoers,dc=mercury,dc=febras,dc=net</span>
objectClass: sudoRole
objectClass: top
cn: defaults
sudoOption: ignore_local_sudoers
sudoOption: env_reset
</pre>
</div>
</div>
</div>

<div id="outline-container-orgheadline23" class="outline-3">
<h3 id="ldap-possibilities"><a id="orgheadline23"></a><a id="ID-4f9ddacc-3908-4cd1-b091-3f00c31aa8a7"></a><span class="section-number-3">3.5</span> Дополнительно. Возможности LDAP</h3>
<div class="outline-text-3" id="text-ldap-possibilities">
<p>
Возможности протокола LDAP значительно определяются схемами, которые
можно подключить с помощью директивы <b>include</b>. Помня об основной
цели, рассмотрим типичные задачи, которые можно решить с их помощью. В
первую очередь, нас интересуют уже готовые схемы, входящие в
дистрибутив <b>OpenLDAP</b> или разработанные сторонними поставщиками.
</p>

<p>
Примеры использования<sup><a id="fnr.6" class="footref" href="#fn.6">6</a></sup> OpenLDAP:
</p>
<ul class="org-ul">
<li>Управление пользователями и группами в <b>OpenLDAP</b></li>
<li>Настройка аутентификации пользователей через <b>OpenLDAP</b> на клиенте</li>
<li>Настройка <b>OpenLDAP</b> в качестве хранилища правил <b>sudo</b> (sudo.schema)</li>
<li><b>OpenLDAP</b> как хранилище карт автоматического монтирования для <b>autofs</b> (autofs.schema)</li>
<li>Репозиторий <b>NFS netgroup</b> на основе <b>OpenLDAP</b> для <b>autofs</b> (nis.schema)</li>
</ul>

<p>
Расширенные возможности систем<sup><a id="fnr.7" class="footref" href="#fn.7">7</a></sup> на базе OpenLDAP:
</p>
<ul class="org-ul">
<li>Управление пользователями
<ul class="org-ul">
<li>Управление квотами пользователей</li>
<li>Управление ssh ключами, сертификатами пользователей</li>
<li>Управление пользователями систем и сервисов</li>
</ul></li>
<li>Управление сервисами и системами
<ul class="org-ul">
<li>Управление сервисами почты, доступа к данным, мониторинга, имен,
печати, резервного копирования, сети, прокси, репозиториев и Web</li>
<li>Управление системами: тонкие клиенты, десктопы, VDI, BYOD,
серверы, VoIP, сетевые и мобильные устройства, узлы кластера</li>
</ul></li>
</ul>
</div>
</div>
</div>

<div id="outline-container-orgheadline30" class="outline-2">
<h2 id="new-user"><a id="orgheadline30"></a><a id="ID-6fe3c37d-639a-4656-9675-bdc7a6c5ddb2"></a><span class="section-number-2">4</span> Процесс добавления нового пользователя в систему</h2>
<div class="outline-text-2" id="text-new-user">
<blockquote>
<p>
Необходимо разработать документацию по процессу добавления нового
пользователя в систему, использующего аутентификацию посредством
LDAP. Предложить CLI (или GUI WEB) интерфейс для выполнения данной
операции. Ориентироваться на использование в ОС <b>CentOS 5/6</b>.
</p>

<p>
Предложить LDAP-варианты для команд <b>passwd</b>, <b>useradd</b>, <b>usermod</b>,
<b>finger</b>, <b>chsh</b>, <b>chfn</b> и функциональности <b>.forward</b>.
</p>
</blockquote>
</div>

<div id="outline-container-orgheadline25" class="outline-3">
<h3 id="new-user-ldap"><a id="orgheadline25"></a><a id="ID-6e8437bc-7e1f-489a-9afb-44f3d67d49ab"></a><span class="section-number-3">4.1</span> Добавление пользователя с помощью CLI интерфейса</h3>
<div class="outline-text-3" id="text-new-user-ldap">
<p class="verse">
Где работаем: контейнеры <b>server-&#x2026;..</b><br  />
</p>

<p>
Используем утилиту <b>ldapadd</b> для добавления записи пользователя в формате <b>ldif</b>
</p>

<div class="org-src-container">

<pre class="src src-sh">ldapadd -x -D <span style="color: #2aa198;">'cn=Manager,dc=mercury,dc=febras,dc=net'</span> -w $<span style="color: #268bd2;">LDAP_MANAGER_PASSWORD</span> -f user.ldif
</pre>
</div>

<div class="org-src-container">
<label class="org-src-name"><b>user.ldif</b>: создание нового пользователя, принадлежащего к группе <b>sudowheel</b></label>
<pre class="src src-ldif"><span style="color: #859900; font-weight: bold;">dn</span>: <span style="color: #268bd2;">uid=username,ou=users,dc=mercury,dc=febras,dc=net</span>
uid: username
cn: User Name
objectClass: account
objectClass: posixAccount
objectClass: top
objectClass: shadowAccount
objectClass: inetLocalMailRecipient
userPassword: p@ssw0rd
shadowLastChange: 17093
shadowMin: 0
shadowMax: 99999
shadowWarning: 7
loginShell: /bin/bash
uidNumber: 1050
gidNumber: 1050
homeDirectory: /home/username
gecos: User Name
mailLocalAddress: username@mercury.febras.net
mailRoutingAddress: username@localhost

<span style="color: #859900; font-weight: bold;">dn</span>: <span style="color: #268bd2;">cn=username,ou=groups,dc=mercury,dc=febras,dc=net</span>
objectClass: posixGroup
objectClass: top
cn: username
gidNumber: 1050
</pre>
</div>

<p>
Полученные (см. подраздел <a href="#add-users">4.5</a>) в результате миграции учетные
записи пользователей кластера добавляются аналогично. Необходимая
функциональность учетной записи пользователя определяется классами
<b>posixAccount</b> и <b>shadowAccount</b>.
</p>
</div>
</div>

<div id="outline-container-orgheadline26" class="outline-3">
<h3 id="new-user-php"><a id="orgheadline26"></a><a id="ID-6de9e6dc-04f2-429d-b22e-55caa2e270ee"></a><span class="section-number-3">4.2</span> Добавление пользователя с помощью GUI Web интерфейса</h3>
<div class="outline-text-3" id="text-new-user-php">
<p class="verse">
Где работаем: контейнер <b>gui</b><br  />
</p>

<p>
Как мы видели, добавление записи в БД LDAP с помощью <b>ldif</b>-файла
сопровождается некоторым дублированием информации и мелкими
неудобствами. Например, приходится дублировать часть уникального имени
<b>dn</b>, хотя при использовании более развитых средств, эта часть могла
быть получена из контекста автоматически. С другой стороны, такая
форма записи "говорит сама за себя": уникальное имя полностью
определяет место объекта в БД, являясь одновременно как описательной
(по аналогии с <b>SQL Data Definition Language</b>) &#x2014; при использовании
<b>ldapsearch</b>, так и модфицирующей (<b>SQL Data Manipulation Language</b>)
конструкцией &#x2014; в случае использования утилит <b>ldapadd/slapadd</b> или
<b>ldapmodify/slapmodify</b>.
</p>

<p>
Далее, приходится дублировать одинаковые для всех записей пользователя
поля <b>objectClass</b>, но с этим вполне можно смириться, поскольку обычно
используется готовый шаблон <b>ldif</b>-файла и уже в него вносятся
изменения. Чуть большее неудобство таит в себе поле <b>gidNumber</b>,
поскольку приходится узнавать и прописывать номер группы. Впрочем, при
небольшом количестве групп, а тем более при наличии одной группы, это
не является проблемой. В нашем случае используется группа, номер
<b>gidNumber</b> которой обычно совпадает с номером <b>uidNumber</b>
пользователя, как это принято в Unix.
</p>

<p>
В случае гибкой работы с настройками <b>shadow</b> полей, такой текстовый
интерфейс начнет приносить ощутимые проблемы, т.к., например, для
полей <b>shadowLastChange</b> и <b>shadowMax</b> необходимо вычислять количество
дней &#x2014; а это уже явно требует автоматизации.
</p>

<p>
Поле <b>userPassword</b> также требует аккуратного обращения: необходимо
каким то образом применять шифрование пароля с помощью утилит
<b>ldappasswd</b> или <b>slappasswd</b>.
</p>

<p>
Эти и другие проблемы может решить GUI интерфейс, который позволяет
с помощью доступных шаблонов и средств описания GUI, реализовывать
нужную функциональность, в некоторых случаях значительно облегчая
работу со схемой каталога LDAP.
</p>
<div align="right">
<a onclick="toggleDiv2('shadow',$(this));" class="fa fa-caret-right">Файлы custom-*.xml</a>
</div>
<div id="shadow" style="display:none">
<div class="org-src-container">
<label class="org-src-name">xml-файл шаблона <b>User Account With Shadow</b> браузера схемы</label>
<pre class="src src-xml">&lt;?<span style="color: #859900; font-weight: bold;">xml</span> <span style="color: #268bd2;">version</span>=<span style="color: #2aa198;">"</span><span style="color: #2aa198;">1.0</span><span style="color: #2aa198;">"</span> <span style="color: #268bd2;">encoding</span>=<span style="color: #2aa198;">"</span><span style="color: #2aa198;">UTF-8</span><span style="color: #2aa198;">"</span> <span style="color: #268bd2;">standalone</span>=<span style="color: #2aa198;">"</span><span style="color: #2aa198;">no</span><span style="color: #2aa198;">"</span>?&gt;
&lt;!<span style="color: #859900; font-weight: bold;">DOCTYPE</span> template <span style="color: #859900; font-weight: bold;">SYSTEM</span> <span style="color: #2aa198;">"</span><span style="color: #2aa198;">../template.dtd</span><span style="color: #2aa198;">"</span>&gt;

&lt;<span style="color: #268bd2;">template</span>&gt;
  &lt;<span style="color: #268bd2;">askcontainer</span>&gt;1&lt;/<span style="color: #268bd2;">askcontainer</span>&gt;
  &lt;<span style="color: #268bd2;">description</span>&gt;New User Account&lt;/<span style="color: #268bd2;">description</span>&gt;
  &lt;<span style="color: #268bd2;">icon</span>&gt;ldap-user.png&lt;/<span style="color: #268bd2;">icon</span>&gt;
  &lt;<span style="color: #268bd2;">invalid</span>&gt;0&lt;/<span style="color: #268bd2;">invalid</span>&gt;
  &lt;<span style="color: #268bd2;">rdn</span>&gt;cn&lt;/<span style="color: #268bd2;">rdn</span>&gt;
  &lt;<span style="color: #268bd2;">title</span>&gt;Generic: User Account with Shadow&lt;/<span style="color: #268bd2;">title</span>&gt;
  &lt;<span style="color: #268bd2;">visible</span>&gt;1&lt;/<span style="color: #268bd2;">visible</span>&gt;

  &lt;<span style="color: #268bd2;">objectClasses</span>&gt;
    &lt;<span style="color: #268bd2;">objectClass</span> <span style="color: #268bd2;">id</span>=<span style="color: #2aa198;">"</span><span style="color: #2aa198;">account</span><span style="color: #2aa198;">"</span>&gt;&lt;/<span style="color: #268bd2;">objectClass</span>&gt;
    &lt;<span style="color: #268bd2;">objectClass</span> <span style="color: #268bd2;">id</span>=<span style="color: #2aa198;">"</span><span style="color: #2aa198;">posixAccount</span><span style="color: #2aa198;">"</span>&gt;&lt;/<span style="color: #268bd2;">objectClass</span>&gt;
    &lt;<span style="color: #268bd2;">objectClass</span> <span style="color: #268bd2;">id</span>=<span style="color: #2aa198;">"</span><span style="color: #2aa198;">top</span><span style="color: #2aa198;">"</span>&gt;&lt;/<span style="color: #268bd2;">objectClass</span>&gt;
    &lt;<span style="color: #268bd2;">objectClass</span> <span style="color: #268bd2;">id</span>=<span style="color: #2aa198;">"</span><span style="color: #2aa198;">shadowAccount</span><span style="color: #2aa198;">"</span>&gt;&lt;/<span style="color: #268bd2;">objectClass</span>&gt;
    &lt;<span style="color: #268bd2;">objectClass</span> <span style="color: #268bd2;">id</span>=<span style="color: #2aa198;">"</span><span style="color: #2aa198;">inetLocalMailRecipient</span><span style="color: #2aa198;">"</span>&gt;&lt;/<span style="color: #268bd2;">objectClass</span>&gt;
  &lt;/<span style="color: #268bd2;">objectClasses</span>&gt;

  &lt;<span style="color: #268bd2;">attributes</span>&gt;
    &lt;<span style="color: #268bd2;">attribute</span> <span style="color: #268bd2;">id</span>=<span style="color: #2aa198;">"</span><span style="color: #2aa198;">uid</span><span style="color: #2aa198;">"</span>&gt;
      &lt;<span style="color: #268bd2;">display</span>&gt;User ID&lt;/<span style="color: #268bd2;">display</span>&gt;
      &lt;<span style="color: #268bd2;">onchange</span>&gt;=autoFill(homeDirectory;/home/%uid%)&lt;/<span style="color: #268bd2;">onchange</span>&gt;
      &lt;<span style="color: #268bd2;">order</span>&gt;1&lt;/<span style="color: #268bd2;">order</span>&gt;
      &lt;<span style="color: #268bd2;">page</span>&gt;1&lt;/<span style="color: #268bd2;">page</span>&gt;
      &lt;<span style="color: #268bd2;">spacer</span>&gt;1&lt;/<span style="color: #268bd2;">spacer</span>&gt;
    &lt;/<span style="color: #268bd2;">attribute</span>&gt;
    &lt;<span style="color: #268bd2;">attribute</span> <span style="color: #268bd2;">id</span>=<span style="color: #2aa198;">"</span><span style="color: #2aa198;">cn</span><span style="color: #2aa198;">"</span>&gt;
      &lt;<span style="color: #268bd2;">display</span>&gt;Common Name&lt;/<span style="color: #268bd2;">display</span>&gt;
      &lt;<span style="color: #268bd2;">order</span>&gt;2&lt;/<span style="color: #268bd2;">order</span>&gt;
      &lt;<span style="color: #268bd2;">page</span>&gt;1&lt;/<span style="color: #268bd2;">page</span>&gt;
    &lt;/<span style="color: #268bd2;">attribute</span>&gt;
    &lt;<span style="color: #268bd2;">attribute</span> <span style="color: #268bd2;">id</span>=<span style="color: #2aa198;">"</span><span style="color: #2aa198;">userPassword</span><span style="color: #2aa198;">"</span>&gt;
      &lt;<span style="color: #268bd2;">display</span>&gt;Password&lt;/<span style="color: #268bd2;">display</span>&gt;
      &lt;<span style="color: #268bd2;">icon</span>&gt;lock.png&lt;/<span style="color: #268bd2;">icon</span>&gt;
      &lt;<span style="color: #268bd2;">order</span>&gt;3&lt;/<span style="color: #268bd2;">order</span>&gt;
      &lt;<span style="color: #268bd2;">page</span>&gt;1&lt;/<span style="color: #268bd2;">page</span>&gt;
      &lt;<span style="color: #268bd2;">post</span>&gt;=php.PasswordEncrypt(%enc%;%userPassword%)&lt;/<span style="color: #268bd2;">post</span>&gt;
      &lt;<span style="color: #268bd2;">spacer</span>&gt;1&lt;/<span style="color: #268bd2;">spacer</span>&gt;
      &lt;<span style="color: #268bd2;">verify</span>&gt;1&lt;/<span style="color: #268bd2;">verify</span>&gt;
    &lt;/<span style="color: #268bd2;">attribute</span>&gt;
    &lt;<span style="color: #268bd2;">attribute</span> <span style="color: #268bd2;">id</span>=<span style="color: #2aa198;">"</span><span style="color: #2aa198;">shadowLastChange</span><span style="color: #2aa198;">"</span>&gt;
      &lt;<span style="color: #268bd2;">display</span>&gt;Password Last Changed (in days since 01 Jan 1970)&lt;/<span style="color: #268bd2;">display</span>&gt;
      &lt;<span style="color: #268bd2;">order</span>&gt;4&lt;/<span style="color: #268bd2;">order</span>&gt;
      &lt;<span style="color: #268bd2;">spacer</span>&gt;1&lt;/<span style="color: #268bd2;">spacer</span>&gt;
      <span style="color: #93a1a1;">&lt;!--</span><span style="color: #93a1a1;"> &lt;value&gt;=php.Function(date;dmY)&lt;/value&gt; </span><span style="color: #93a1a1;">--&gt;</span>
      &lt;<span style="color: #268bd2;">value</span>&gt;0&lt;/<span style="color: #268bd2;">value</span>&gt;
    &lt;/<span style="color: #268bd2;">attribute</span>&gt;
    &lt;<span style="color: #268bd2;">attribute</span> <span style="color: #268bd2;">id</span>=<span style="color: #2aa198;">"</span><span style="color: #2aa198;">shadowMin</span><span style="color: #2aa198;">"</span>&gt;
      &lt;<span style="color: #268bd2;">display</span>&gt;Password may be changed (days before)&lt;/<span style="color: #268bd2;">display</span>&gt;
      &lt;<span style="color: #268bd2;">order</span>&gt;5&lt;/<span style="color: #268bd2;">order</span>&gt;
      &lt;<span style="color: #268bd2;">spacer</span>&gt;1&lt;/<span style="color: #268bd2;">spacer</span>&gt;
      &lt;<span style="color: #268bd2;">value</span>&gt;0&lt;/<span style="color: #268bd2;">value</span>&gt;
    &lt;/<span style="color: #268bd2;">attribute</span>&gt;
    &lt;<span style="color: #268bd2;">attribute</span> <span style="color: #268bd2;">id</span>=<span style="color: #2aa198;">"</span><span style="color: #2aa198;">shadowMax</span><span style="color: #2aa198;">"</span>&gt;
      &lt;<span style="color: #268bd2;">display</span>&gt;Password Validity (in days)&lt;/<span style="color: #268bd2;">display</span>&gt;
      &lt;<span style="color: #268bd2;">order</span>&gt;6&lt;/<span style="color: #268bd2;">order</span>&gt;
      &lt;<span style="color: #268bd2;">spacer</span>&gt;1&lt;/<span style="color: #268bd2;">spacer</span>&gt;
      &lt;<span style="color: #268bd2;">value</span>&gt;3650&lt;/<span style="color: #268bd2;">value</span>&gt;
    &lt;/<span style="color: #268bd2;">attribute</span>&gt;
    &lt;<span style="color: #268bd2;">attribute</span> <span style="color: #268bd2;">id</span>=<span style="color: #2aa198;">"</span><span style="color: #2aa198;">shadowWarning</span><span style="color: #2aa198;">"</span>&gt;
      &lt;<span style="color: #268bd2;">display</span>&gt;Password Change Warning (days before expiry)&lt;/<span style="color: #268bd2;">display</span>&gt;
      &lt;<span style="color: #268bd2;">order</span>&gt;7&lt;/<span style="color: #268bd2;">order</span>&gt;
      &lt;<span style="color: #268bd2;">spacer</span>&gt;1&lt;/<span style="color: #268bd2;">spacer</span>&gt;
      &lt;<span style="color: #268bd2;">value</span>&gt;5&lt;/<span style="color: #268bd2;">value</span>&gt;
    &lt;/<span style="color: #268bd2;">attribute</span>&gt;
    &lt;<span style="color: #268bd2;">attribute</span> <span style="color: #268bd2;">id</span>=<span style="color: #2aa198;">"</span><span style="color: #2aa198;">loginShell</span><span style="color: #2aa198;">"</span>&gt;
      &lt;<span style="color: #268bd2;">display</span>&gt;Login shell&lt;/<span style="color: #268bd2;">display</span>&gt;
      &lt;<span style="color: #268bd2;">order</span>&gt;8&lt;/<span style="color: #268bd2;">order</span>&gt;
      &lt;<span style="color: #268bd2;">page</span>&gt;1&lt;/<span style="color: #268bd2;">page</span>&gt;
      &lt;<span style="color: #268bd2;">default</span>&gt;/bin/bash&lt;/<span style="color: #268bd2;">default</span>&gt;
      &lt;<span style="color: #268bd2;">type</span>&gt;select&lt;/<span style="color: #268bd2;">type</span>&gt;
      &lt;<span style="color: #268bd2;">value</span> <span style="color: #268bd2;">id</span>=<span style="color: #2aa198;">"</span><span style="color: #2aa198;">/bin/bash</span><span style="color: #2aa198;">"</span>&gt;Bash&lt;/<span style="color: #268bd2;">value</span>&gt;
      &lt;<span style="color: #268bd2;">value</span> <span style="color: #268bd2;">id</span>=<span style="color: #2aa198;">"</span><span style="color: #2aa198;">/bin/sh</span><span style="color: #2aa198;">"</span>&gt;Dash&lt;/<span style="color: #268bd2;">value</span>&gt;
    &lt;/<span style="color: #268bd2;">attribute</span>&gt;
    &lt;<span style="color: #268bd2;">attribute</span> <span style="color: #268bd2;">id</span>=<span style="color: #2aa198;">"</span><span style="color: #2aa198;">uidNumber</span><span style="color: #2aa198;">"</span>&gt;
      &lt;<span style="color: #268bd2;">display</span>&gt;UID Number&lt;/<span style="color: #268bd2;">display</span>&gt;
      &lt;<span style="color: #268bd2;">icon</span>&gt;terminal.png&lt;/<span style="color: #268bd2;">icon</span>&gt;
      &lt;<span style="color: #268bd2;">order</span>&gt;9&lt;/<span style="color: #268bd2;">order</span>&gt;
      &lt;<span style="color: #268bd2;">page</span>&gt;1&lt;/<span style="color: #268bd2;">page</span>&gt;
      &lt;<span style="color: #268bd2;">readonly</span>&gt;1&lt;/<span style="color: #268bd2;">readonly</span>&gt;
      &lt;<span style="color: #268bd2;">value</span>&gt;=php.GetNextNumber(/;uidNumber)&lt;/<span style="color: #268bd2;">value</span>&gt;
    &lt;/<span style="color: #268bd2;">attribute</span>&gt;
    &lt;<span style="color: #268bd2;">attribute</span> <span style="color: #268bd2;">id</span>=<span style="color: #2aa198;">"</span><span style="color: #2aa198;">gidNumber</span><span style="color: #2aa198;">"</span>&gt;
      &lt;<span style="color: #268bd2;">display</span>&gt;GID Number&lt;/<span style="color: #268bd2;">display</span>&gt;
      &lt;<span style="color: #268bd2;">order</span>&gt;10&lt;/<span style="color: #268bd2;">order</span>&gt;
      &lt;<span style="color: #268bd2;">page</span>&gt;1&lt;/<span style="color: #268bd2;">page</span>&gt;
      <span style="color: #93a1a1;">&lt;!--</span><span style="color: #93a1a1;"> &lt;value&gt;&lt;![CDATA[=php.PickList(/;(&amp;(objectClass=posixGroup));gidNumber;%cn%;;;;cn)]]&gt;&lt;/value&gt; </span><span style="color: #93a1a1;">--&gt;</span>
      &lt;<span style="color: #268bd2;">value</span>&gt;=php.GetNextNumber(/;uidNumber)&lt;/<span style="color: #268bd2;">value</span>&gt;
    &lt;/<span style="color: #268bd2;">attribute</span>&gt;
    &lt;<span style="color: #268bd2;">attribute</span> <span style="color: #268bd2;">id</span>=<span style="color: #2aa198;">"</span><span style="color: #2aa198;">homeDirectory</span><span style="color: #2aa198;">"</span>&gt;
      &lt;<span style="color: #268bd2;">display</span>&gt;Home directory&lt;/<span style="color: #268bd2;">display</span>&gt;
      &lt;<span style="color: #268bd2;">order</span>&gt;11&lt;/<span style="color: #268bd2;">order</span>&gt;
      &lt;<span style="color: #268bd2;">page</span>&gt;1&lt;/<span style="color: #268bd2;">page</span>&gt;
    &lt;/<span style="color: #268bd2;">attribute</span>&gt;
    &lt;<span style="color: #268bd2;">attribute</span> <span style="color: #268bd2;">id</span>=<span style="color: #2aa198;">"</span><span style="color: #2aa198;">gecos</span><span style="color: #2aa198;">"</span>&gt;
      &lt;<span style="color: #268bd2;">display</span>&gt;GECOS&lt;/<span style="color: #268bd2;">display</span>&gt;
      &lt;<span style="color: #268bd2;">order</span>&gt;12&lt;/<span style="color: #268bd2;">order</span>&gt;
      &lt;<span style="color: #268bd2;">page</span>&gt;1&lt;/<span style="color: #268bd2;">page</span>&gt;
    &lt;/<span style="color: #268bd2;">attribute</span>&gt;
    &lt;<span style="color: #268bd2;">attribute</span> <span style="color: #268bd2;">id</span>=<span style="color: #2aa198;">"</span><span style="color: #2aa198;">mailLocalAddress</span><span style="color: #2aa198;">"</span>&gt;
      &lt;<span style="color: #268bd2;">display</span>&gt;Mail Local Address&lt;/<span style="color: #268bd2;">display</span>&gt;
      &lt;<span style="color: #268bd2;">order</span>&gt;13&lt;/<span style="color: #268bd2;">order</span>&gt;
      &lt;<span style="color: #268bd2;">page</span>&gt;1&lt;/<span style="color: #268bd2;">page</span>&gt;
    &lt;/<span style="color: #268bd2;">attribute</span>&gt;
    &lt;<span style="color: #268bd2;">attribute</span> <span style="color: #268bd2;">id</span>=<span style="color: #2aa198;">"</span><span style="color: #2aa198;">mailRoutingAddress</span><span style="color: #2aa198;">"</span>&gt;
      &lt;<span style="color: #268bd2;">display</span>&gt;Mail Routing Address&lt;/<span style="color: #268bd2;">display</span>&gt;
      &lt;<span style="color: #268bd2;">order</span>&gt;14&lt;/<span style="color: #268bd2;">order</span>&gt;
      &lt;<span style="color: #268bd2;">page</span>&gt;1&lt;/<span style="color: #268bd2;">page</span>&gt;
    &lt;/<span style="color: #268bd2;">attribute</span>&gt;
  &lt;/<span style="color: #268bd2;">attributes</span>&gt;
&lt;/<span style="color: #268bd2;">template</span>&gt;
</pre>
</div>
<div class="org-src-container">
<label class="org-src-name">xml-файл шаблона <b>Posix Group</b> браузера схемы</label>
<pre class="src src-xml">&lt;?<span style="color: #859900; font-weight: bold;">xml</span> <span style="color: #268bd2;">version</span>=<span style="color: #2aa198;">"</span><span style="color: #2aa198;">1.0</span><span style="color: #2aa198;">"</span> <span style="color: #268bd2;">encoding</span>=<span style="color: #2aa198;">"</span><span style="color: #2aa198;">UTF-8</span><span style="color: #2aa198;">"</span> <span style="color: #268bd2;">standalone</span>=<span style="color: #2aa198;">"</span><span style="color: #2aa198;">no</span><span style="color: #2aa198;">"</span>?&gt;
&lt;!<span style="color: #859900; font-weight: bold;">DOCTYPE</span> template <span style="color: #859900; font-weight: bold;">SYSTEM</span> <span style="color: #2aa198;">"</span><span style="color: #2aa198;">template.dtd</span><span style="color: #2aa198;">"</span>&gt;

&lt;<span style="color: #268bd2;">template</span>&gt;
&lt;<span style="color: #268bd2;">askcontainer</span>&gt;1&lt;/<span style="color: #268bd2;">askcontainer</span>&gt;
&lt;<span style="color: #268bd2;">description</span>&gt;New Posix Group&lt;/<span style="color: #268bd2;">description</span>&gt;
&lt;<span style="color: #268bd2;">icon</span>&gt;ldap-ou.png&lt;/<span style="color: #268bd2;">icon</span>&gt;
&lt;<span style="color: #268bd2;">invalid</span>&gt;0&lt;/<span style="color: #268bd2;">invalid</span>&gt;
&lt;<span style="color: #268bd2;">rdn</span>&gt;cn&lt;/<span style="color: #268bd2;">rdn</span>&gt;
<span style="color: #93a1a1;">&lt;!--</span><span style="color: #93a1a1;"> &lt;regexp&gt;^ou=.*,&lt;/regexp&gt; </span><span style="color: #93a1a1;">--&gt;</span>
&lt;<span style="color: #268bd2;">title</span>&gt;Generic: Posix Group&lt;/<span style="color: #268bd2;">title</span>&gt;
&lt;<span style="color: #268bd2;">visible</span>&gt;1&lt;/<span style="color: #268bd2;">visible</span>&gt;

&lt;<span style="color: #268bd2;">objectClasses</span>&gt;
&lt;<span style="color: #268bd2;">objectClass</span> <span style="color: #268bd2;">id</span>=<span style="color: #2aa198;">"</span><span style="color: #2aa198;">posixGroup</span><span style="color: #2aa198;">"</span>&gt;&lt;/<span style="color: #268bd2;">objectClass</span>&gt;
&lt;/<span style="color: #268bd2;">objectClasses</span>&gt;

&lt;<span style="color: #268bd2;">attributes</span>&gt;
&lt;<span style="color: #268bd2;">attribute</span> <span style="color: #268bd2;">id</span>=<span style="color: #2aa198;">"</span><span style="color: #2aa198;">cn</span><span style="color: #2aa198;">"</span>&gt;
        &lt;<span style="color: #268bd2;">display</span>&gt;Group&lt;/<span style="color: #268bd2;">display</span>&gt;
        &lt;<span style="color: #268bd2;">order</span>&gt;1&lt;/<span style="color: #268bd2;">order</span>&gt;
        &lt;<span style="color: #268bd2;">page</span>&gt;1&lt;/<span style="color: #268bd2;">page</span>&gt;
&lt;/<span style="color: #268bd2;">attribute</span>&gt;
&lt;<span style="color: #268bd2;">attribute</span> <span style="color: #268bd2;">id</span>=<span style="color: #2aa198;">"</span><span style="color: #2aa198;">gidNumber</span><span style="color: #2aa198;">"</span>&gt;
        &lt;<span style="color: #268bd2;">display</span>&gt;GID Number&lt;/<span style="color: #268bd2;">display</span>&gt;
        &lt;<span style="color: #268bd2;">order</span>&gt;2&lt;/<span style="color: #268bd2;">order</span>&gt;
        &lt;<span style="color: #268bd2;">page</span>&gt;1&lt;/<span style="color: #268bd2;">page</span>&gt;
        &lt;<span style="color: #268bd2;">readonly</span>&gt;1&lt;/<span style="color: #268bd2;">readonly</span>&gt;
        &lt;<span style="color: #268bd2;">spacer</span>&gt;1&lt;/<span style="color: #268bd2;">spacer</span>&gt;
        &lt;<span style="color: #268bd2;">value</span>&gt;=php.GetNextNumber(/;gidNumber)&lt;/<span style="color: #268bd2;">value</span>&gt;
        <span style="color: #93a1a1;">&lt;!--</span><span style="color: #93a1a1;"> &lt;value&gt;&lt;![CDATA[=php.GetNextNumber(/;gidNumber;false;(&amp;(objectClass=posixGroup));*2,+1000)]]&gt;&lt;/value&gt; </span><span style="color: #93a1a1;">--&gt;</span>
&lt;/<span style="color: #268bd2;">attribute</span>&gt;
&lt;<span style="color: #268bd2;">attribute</span> <span style="color: #268bd2;">id</span>=<span style="color: #2aa198;">"</span><span style="color: #2aa198;">memberUid</span><span style="color: #2aa198;">"</span>&gt;
        &lt;<span style="color: #268bd2;">display</span>&gt;Users&lt;/<span style="color: #268bd2;">display</span>&gt;
        &lt;<span style="color: #268bd2;">hidden</span>&gt;0&lt;/<span style="color: #268bd2;">hidden</span>&gt;
        &lt;<span style="color: #268bd2;">order</span>&gt;3&lt;/<span style="color: #268bd2;">order</span>&gt;
        &lt;<span style="color: #268bd2;">page</span>&gt;1&lt;/<span style="color: #268bd2;">page</span>&gt;
        &lt;<span style="color: #268bd2;">value</span>&gt;&lt;![<span style="color: #657b83; font-weight: bold;">CDATA</span>[=php.MultiList(/;(&amp;(objectClass=posixAccount));uid;%cn% (%uid|-4%))]]&gt;&lt;/<span style="color: #268bd2;">value</span>&gt;
&lt;/<span style="color: #268bd2;">attribute</span>&gt;
&lt;/<span style="color: #268bd2;">attributes</span>&gt;

&lt;/<span style="color: #268bd2;">template</span>&gt;
</pre>
</div>
</div>


<div id="orgparagraph1" class="figure">
<p><img src="./php01.png" alt="php01.png" />
</p>
<p><span class="figure-number">&#1056;&#1080;&#1089;. 1.:</span> Создание пользователя и его группы с использованием шаблона phpLDAPadmin</p>
</div>
</div>
</div>

<div id="outline-container-orgheadline27" class="outline-3">
<h3 id="test-client"><a id="orgheadline27"></a><a id="ID-061371a3-a5d6-4fa2-9e15-2d8adef5caf0"></a><span class="section-number-3">4.3</span> Тестирование клиентского подключения</h3>
<div class="outline-text-3" id="text-test-client">
<p class="verse">
Где работаем: контейнеры <b>client.</b><br  />
</p>

<p>
Для проверки возможности аутентификации будем использовать запись
 <b>username</b> (см. подраздел <a href="#new-user-ldap">4.1</a>). Протестируем подключение с
помощью команды
</p>
<div class="org-src-container">

<pre class="src src-sh">getent passwd username
</pre>
</div>
<p>
которая выводит passwd данные пользователя <b>username</b> из доступных
источников, в данном случае задействован сервер LDAP
</p>
<div class="org-src-container">

<pre class="src src-conf-colon"><span style="color: #268bd2;">username</span>:x:1050:1050:User Name:/home/username:/bin/bash
</pre>
</div>

<p class="verse">
Где работаем: локальная сеть контейнеров<br  />
</p>

<p>
Убедимся, что механизм <b>sudoers</b> задействован. Вывод команды
</p>
<div class="org-src-container">

<pre class="src src-sh">sshpass -p p@ssw0rd ssh -t username@$(<span style="color: #6c71c4; font-weight: bold;">ip</span>) sudo ls /root
</pre>
</div>
<p>
демонстрирует, что пользователь <b>username</b> успешно прочитал содержимое
директории <b>root</b> с помощью <b>sudo</b>
</p>
<div class="org-src-container">

<pre class="src src-raw">Dockerfile5  Dockerfile6  run5.sh  run6.sh
</pre>
</div>
</div>
</div>

<div id="outline-container-orgheadline28" class="outline-3">
<h3 id="standard-commands"><a id="orgheadline28"></a><a id="ID-84d40fcf-c285-40e6-9f13-11685889a085"></a><span class="section-number-3">4.4</span> Стандартные команды администрирования пользователей в случае использования LDAP</h3>
<div class="outline-text-3" id="text-standard-commands">
<p class="verse">
Где работаем: любой хост в локальной сети контейнеров с установленными утилитами openldap-client<br  />
</p>

<p>
В подразделе <a href="#hdb-domain-config">3.2</a>
устанавливаются разрешения для полей <b>userPassword</b> и
<b>shadowLastChange</b>, чтобы пользователь имел право на смену пароля.
</p>

<div class="org-src-container">
<label class="org-src-name">Изменение пользователем своего пароля с помощью утилиты <b>ldappasswd</b></label>
<pre class="src src-sh">    ldappasswd -h $<span style="color: #268bd2;">1</span> -x -D <span style="color: #2aa198;">"uid=username,ou=users,dc=mercury,dc=febras,dc=net"</span> -w p@ssw0rd -s new_p@ssw0rd
</pre>
</div>

<div class="warning">
<p>
При использовании утилиты <b>ldappasswd</b> изменения атрибута
<b>shadowLastChange</b> не происходит. Его необходимо задавать отдельно с
помощью утилиты <b>ldapmodify</b>. В случае применения утилиты <b>passwd</b>,
атрибут <b>shadowLastChange</b> корректно обновляется в LDAP (благодаря
действиям PAM) при наличии соответствующих прав доступа на запись.
</p>

</div>

<div class="org-src-container">
<label class="org-src-name">Изменение менеджером домена значения <b>loginShell</b> с помощью утилиты <b>ldapmodify</b></label>
<pre class="src src-sh">    ldapmodify -h $<span style="color: #268bd2;">1</span> -x -D <span style="color: #2aa198;">"cn=Manager,dc=mercury,dc=febras,dc=net"</span> -w manager &lt;&lt;EOF
<span style="color: #b58900; font-weight: bold;">dn: uid=username,ou=users,dc=mercury,dc=febras,dc=net</span>
<span style="color: #b58900; font-weight: bold;">changetype: modify</span>
<span style="color: #b58900; font-weight: bold;">replace: loginShell</span>
<span style="color: #b58900; font-weight: bold;">loginShell: /bin/sh</span>
<span style="color: #b58900; font-weight: bold;">-</span>
<span style="color: #b58900; font-weight: bold;">EOF</span>
    ldapsearch -x -h $<span style="color: #268bd2;">1</span> -LLL -D <span style="color: #2aa198;">'cn=Manager,dc=mercury,dc=febras,dc=net'</span> -b <span style="color: #2aa198;">'uid=username,ou=users,dc=mercury,dc=febras,dc=net'</span> <span style="color: #2aa198;">'(loginShell=*)'</span> -w manager | grep loginShell
</pre>
</div>

<p>
Значение <b>loginShell: /bin/bash</b>, указанное в файле <b>user.ldif</b>, изменилось на <b>/bin/sh</b>:
</p>

<pre class="example">
modifying entry "uid=username,ou=users,dc=mercury,dc=febras,dc=net"

loginShell: /bin/sh
</pre>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">
<caption class="t-above"><span class="table-number">&#1058;&#1072;&#1073;&#1083;&#1080;&#1094;&#1072; 3.:</span> Замещение стандартных команд в случае использования LDAP</caption>

<colgroup>
<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">Утилита</th>
<th scope="col" class="org-left">Работает с LDAP</th>
<th scope="col" class="org-left">Примечание</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left"><b>passwd</b></td>
<td class="org-left"><b>Да</b></td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left"><b>useradd</b></td>
<td class="org-left">Нет</td>
<td class="org-left"><b>luseradd</b> или <b>ldapadd</b>, атрибуты классов <b>posixAccount</b>, <b>shadowAccount</b></td>
</tr>

<tr>
<td class="org-left"><b>usermod</b></td>
<td class="org-left">Нет</td>
<td class="org-left"><b>lusermod</b> или <b>ldapmodify</b>, атрибуты классов <b>posixAccount</b>, <b>shadowAccount</b></td>
</tr>

<tr>
<td class="org-left"><b>groupadd</b></td>
<td class="org-left">Нет</td>
<td class="org-left"><b>lgroupadd</b> или <b>ldapadd</b>, атрибуты класса <b>posixGroup</b></td>
</tr>

<tr>
<td class="org-left"><b>groupmod</b></td>
<td class="org-left">Нет</td>
<td class="org-left"><b>lgroupmod</b> или <b>ldapmodify</b>, атрибуты класса <b>posixGroup</b></td>
</tr>

<tr>
<td class="org-left"><b>finger</b></td>
<td class="org-left"><b>Да</b></td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left"><b>chsh</b></td>
<td class="org-left">Нет</td>
<td class="org-left"><b>ldapmodify</b>, атрибут <b>loginShell</b></td>
</tr>

<tr>
<td class="org-left"><b>chfn</b></td>
<td class="org-left">Нет</td>
<td class="org-left"><b>ldapmodify</b>, атрибут <b>gecos</b></td>
</tr>

<tr>
<td class="org-left">файл <b>.forward</b></td>
<td class="org-left">Нет</td>
<td class="org-left">атрибут <b>mailRoutingAddress</b> класса <b>inetLocalMailRecipient</b></td>
</tr>
</tbody>
</table>

<div class="tip">
<p>
Утилиты <b>luseradd</b>, <b>lusermod</b>, <b>lgroupadd</b> и <b>lgroupmod</b> принадлежат
библиотеке <b>libuser</b>, а утилиты <b>ldapadd</b> и <b>ldapmodify</b> содержатся в
пакете <b>openldap-clients</b>.
</p>

</div>

<div class="note">
<p>
В файле <b>/etc/nsswitch.conf</b> указывается порядок обращения к базам
данных (слева направо): <b>files</b> <b>ldap</b>. Если использовать команду
<i>passwd username</i>, вызываемую от имени суперпользователя, то поиск
пользователя <b>username</b> будет осуществляться сначала в базе <b>files</b> и,
если он там присутствует, произойдет смена пароля. До базы <b>ldap</b> в
этом случае поиск не дойдет, даже в случае наличия в ней пользователя
<b>username</b>. Однако, если войти в систему под учетной записью
<b>username</b>, используя пароль из базы <b>ldap</b>, и использовать команду
<i>passwd</i> (т.е. смену пароля для текущего пользователя), то произойдет
смена пароля в базе <b>ldap</b>, а база <b>files</b> останется без изменений.
</p>

</div>
</div>
</div>

<div id="outline-container-orgheadline29" class="outline-3">
<h3 id="add-users"><a id="orgheadline29"></a><a id="ID-3c998117-af2e-4965-94c7-3ebfb31d7691"></a><span class="section-number-3">4.5</span> Миграция пользователей и групп</h3>
<div class="outline-text-3" id="text-add-users">
<div class="org-src-container">
<label class="org-src-name">Миграция пользователей и групп для <b>5/2.3</b></label>
<pre class="src src-sh"><span style="color: #268bd2;">LDAP_BASEDN</span>=<span style="color: #268bd2;">dc</span>=mercury,<span style="color: #268bd2;">dc</span>=febras,<span style="color: #268bd2;">dc</span>=net
/usr/share/openldap/migration/migrate_passwd.pl /etc/passwd &gt; /gen/mercury.ldif
/usr/share/openldap/migration/migrate_group.pl /etc/group &gt;&gt; /gen/mercury.ldif
sed -i <span style="color: #2aa198;">"s|ou=People|ou=users|g"</span> /gen/mercury.ldif
sed -i <span style="color: #2aa198;">"s|ou=Group|ou=groups|g"</span> /gen/mercury.ldif
</pre>
</div>

<div class="org-src-container">
<label class="org-src-name">Миграция пользователей и групп для <b>6/2.4</b></label>
<pre class="src src-sh"><span style="color: #268bd2;">LDAP_BASEDN</span>=<span style="color: #268bd2;">dc</span>=mercury,<span style="color: #268bd2;">dc</span>=febras,<span style="color: #268bd2;">dc</span>=net
/usr/share/migrationtools/migrate_passwd.pl /etc/passwd &gt; /gen/mercury.ldif
/usr/share/migrationtools/migrate_group.pl /etc/group &gt;&gt; /gen/mercury.ldif
sed -i <span style="color: #2aa198;">"s|ou=People|ou=users|g"</span> /gen/mercury.ldif
sed -i <span style="color: #2aa198;">"s|ou=Group|ou=groups|g"</span> /gen/mercury.ldif
</pre>
</div>

<div class="note">
<p>
Файл <b>/etc/shadow</b> считывается утилитой <b>migrate_passwd.pl</b> при
наличии прав доступа, класс <b>shadowAccount</b>, поля
<b>shadowLastChange</b> и т.п. будут добавлены.
</p>

</div>

<div class="org-src-container">
<label class="org-src-name"><b>mercury.ldif</b>: пример результата миграции пользователей и групп с помощью утилит <b>migrationtools</b></label>
<pre class="src src-ldif"><span style="color: #859900; font-weight: bold;">dn</span>: <span style="color: #268bd2;">uid=abinit1,ou=users,dc=mercury,dc=febras,dc=net</span>
uid: abinit1
cn: abinit1
objectClass: account
objectClass: posixAccount
objectClass: top
userPassword: {crypt}x
loginShell: /bin/bash
uidNumber: 693
gidNumber: 691
homeDirectory: /home/gridxxx/abinit1

<span style="color: #859900; font-weight: bold;">dn</span>: <span style="color: #268bd2;">uid=ngrid1,ou=users,dc=mercury,dc=febras,dc=net</span>
uid: ngrid1
cn: ngrid1
objectClass: account
objectClass: posixAccount
objectClass: top
userPassword: {crypt}x
loginShell: /bin/bash
uidNumber: 671
gidNumber: 681
homeDirectory: /home/gridxxx/ngrid1

<span style="color: #859900; font-weight: bold;">dn</span>: <span style="color: #268bd2;">uid=ngrid,ou=users,dc=mercury,dc=febras,dc=net</span>
uid: ngrid
cn: ngrid
objectClass: account
objectClass: posixAccount
objectClass: top
userPassword: {crypt}x
loginShell: /bin/bash
uidNumber: 680
gidNumber: 681
homeDirectory: /home/gridxxx/ngrid

<span style="color: #859900; font-weight: bold;">dn</span>: <span style="color: #268bd2;">cn=ngrid,ou=groups,dc=mercury,dc=febras,dc=net</span>
objectClass: posixGroup
objectClass: top
cn: ngrid
userPassword: {crypt}x
gidNumber: 681

<span style="color: #859900; font-weight: bold;">dn</span>: <span style="color: #268bd2;">cn=abinit,ou=groups,dc=mercury,dc=febras,dc=net</span>
objectClass: posixGroup
objectClass: top
cn: abinit
userPassword: {crypt}x
gidNumber: 691
</pre>
</div>

<a onclick="toggleDiv2('myContent-passwd',$(this));" class="fa fa-caret-right">passwd.ldif</a>

<div id="myContent-passwd" style="display:none">
<div class="org-src-container">

<pre class="src src-ldif"><span style="color: #859900; font-weight: bold;">dn</span>: <span style="color: #268bd2;">uid=root,ou=People,dc=mercury,dc=febras,dc=net</span>
uid: root
cn: root
objectClass: account
objectClass: posixAccount
objectClass: top
objectClass: shadowAccount
userPassword: {crypt}$1$cMgX2/5Z$2dBOIa75mWgeQCeoDGYMA0
shadowLastChange: 17191
shadowMin: 0
shadowMax: 99999
shadowWarning: 7
loginShell: /bin/bash
uidNumber: 0
gidNumber: 0
homeDirectory: /root
gecos: root

<span style="color: #859900; font-weight: bold;">dn</span>: <span style="color: #268bd2;">uid=bin,ou=People,dc=mercury,dc=febras,dc=net</span>
uid: bin
cn: bin
objectClass: account
objectClass: posixAccount
objectClass: top
objectClass: shadowAccount
userPassword: {crypt}*
shadowLastChange: 17191
shadowMin: 0
shadowMax: 99999
shadowWarning: 7
loginShell: /sbin/nologin
uidNumber: 1
gidNumber: 1
homeDirectory: /bin
gecos: bin

<span style="color: #859900; font-weight: bold;">dn</span>: <span style="color: #268bd2;">uid=daemon,ou=People,dc=mercury,dc=febras,dc=net</span>
uid: daemon
cn: daemon
objectClass: account
objectClass: posixAccount
objectClass: top
objectClass: shadowAccount
userPassword: {crypt}*
shadowLastChange: 17191
shadowMin: 0
shadowMax: 99999
shadowWarning: 7
loginShell: /sbin/nologin
uidNumber: 2
gidNumber: 2
homeDirectory: /sbin
gecos: daemon

<span style="color: #859900; font-weight: bold;">dn</span>: <span style="color: #268bd2;">uid=adm,ou=People,dc=mercury,dc=febras,dc=net</span>
uid: adm
cn: adm
objectClass: account
objectClass: posixAccount
objectClass: top
objectClass: shadowAccount
userPassword: {crypt}*
shadowLastChange: 17191
shadowMin: 0
shadowMax: 99999
shadowWarning: 7
loginShell: /sbin/nologin
uidNumber: 3
gidNumber: 4
homeDirectory: /var/adm
gecos: adm

<span style="color: #859900; font-weight: bold;">dn</span>: <span style="color: #268bd2;">uid=lp,ou=People,dc=mercury,dc=febras,dc=net</span>
uid: lp
cn: lp
objectClass: account
objectClass: posixAccount
objectClass: top
objectClass: shadowAccount
userPassword: {crypt}*
shadowLastChange: 17191
shadowMin: 0
shadowMax: 99999
shadowWarning: 7
loginShell: /sbin/nologin
uidNumber: 4
gidNumber: 7
homeDirectory: /var/spool/lpd
gecos: lp

<span style="color: #859900; font-weight: bold;">dn</span>: <span style="color: #268bd2;">uid=sync,ou=People,dc=mercury,dc=febras,dc=net</span>
uid: sync
cn: sync
objectClass: account
objectClass: posixAccount
objectClass: top
objectClass: shadowAccount
userPassword: {crypt}*
shadowLastChange: 17191
shadowMin: 0
shadowMax: 99999
shadowWarning: 7
loginShell: /bin/sync
uidNumber: 5
gidNumber: 0
homeDirectory: /sbin
gecos: sync

<span style="color: #859900; font-weight: bold;">dn</span>: <span style="color: #268bd2;">uid=shutdown,ou=People,dc=mercury,dc=febras,dc=net</span>
uid: shutdown
cn: shutdown
objectClass: account
objectClass: posixAccount
objectClass: top
objectClass: shadowAccount
userPassword: {crypt}*
shadowLastChange: 17191
shadowMin: 0
shadowMax: 99999
shadowWarning: 7
loginShell: /sbin/shutdown
uidNumber: 6
gidNumber: 0
homeDirectory: /sbin
gecos: shutdown

<span style="color: #859900; font-weight: bold;">dn</span>: <span style="color: #268bd2;">uid=halt,ou=People,dc=mercury,dc=febras,dc=net</span>
uid: halt
cn: halt
objectClass: account
objectClass: posixAccount
objectClass: top
objectClass: shadowAccount
userPassword: {crypt}*
shadowLastChange: 17191
shadowMin: 0
shadowMax: 99999
shadowWarning: 7
loginShell: /sbin/halt
uidNumber: 7
gidNumber: 0
homeDirectory: /sbin
gecos: halt

<span style="color: #859900; font-weight: bold;">dn</span>: <span style="color: #268bd2;">uid=mail,ou=People,dc=mercury,dc=febras,dc=net</span>
uid: mail
cn: mail
objectClass: account
objectClass: posixAccount
objectClass: top
objectClass: shadowAccount
userPassword: {crypt}*
shadowLastChange: 17191
shadowMin: 0
shadowMax: 99999
shadowWarning: 7
loginShell: /sbin/nologin
uidNumber: 8
gidNumber: 12
homeDirectory: /var/spool/mail
gecos: mail

<span style="color: #859900; font-weight: bold;">dn</span>: <span style="color: #268bd2;">uid=news,ou=People,dc=mercury,dc=febras,dc=net</span>
uid: news
cn: news
objectClass: account
objectClass: posixAccount
objectClass: top
objectClass: shadowAccount
userPassword: {crypt}*
shadowLastChange: 17191
shadowMin: 0
shadowMax: 99999
shadowWarning: 7
uidNumber: 9
gidNumber: 13
homeDirectory: /etc/news
gecos: news

<span style="color: #859900; font-weight: bold;">dn</span>: <span style="color: #268bd2;">uid=uucp,ou=People,dc=mercury,dc=febras,dc=net</span>
uid: uucp
cn: uucp
objectClass: account
objectClass: posixAccount
objectClass: top
objectClass: shadowAccount
userPassword: {crypt}*
shadowLastChange: 17191
shadowMin: 0
shadowMax: 99999
shadowWarning: 7
loginShell: /sbin/nologin
uidNumber: 10
gidNumber: 14
homeDirectory: /var/spool/uucp
gecos: uucp

<span style="color: #859900; font-weight: bold;">dn</span>: <span style="color: #268bd2;">uid=operator,ou=People,dc=mercury,dc=febras,dc=net</span>
uid: operator
cn: operator
objectClass: account
objectClass: posixAccount
objectClass: top
objectClass: shadowAccount
userPassword: {crypt}*
shadowLastChange: 17191
shadowMin: 0
shadowMax: 99999
shadowWarning: 7
loginShell: /sbin/nologin
uidNumber: 11
gidNumber: 0
homeDirectory: /root
gecos: operator

<span style="color: #859900; font-weight: bold;">dn</span>: <span style="color: #268bd2;">uid=games,ou=People,dc=mercury,dc=febras,dc=net</span>
uid: games
cn: games
objectClass: account
objectClass: posixAccount
objectClass: top
objectClass: shadowAccount
userPassword: {crypt}*
shadowLastChange: 17191
shadowMin: 0
shadowMax: 99999
shadowWarning: 7
loginShell: /sbin/nologin
uidNumber: 12
gidNumber: 100
homeDirectory: /usr/games
gecos: games

<span style="color: #859900; font-weight: bold;">dn</span>: <span style="color: #268bd2;">uid=gopher,ou=People,dc=mercury,dc=febras,dc=net</span>
uid: gopher
cn: gopher
objectClass: account
objectClass: posixAccount
objectClass: top
objectClass: shadowAccount
userPassword: {crypt}*
shadowLastChange: 17191
shadowMin: 0
shadowMax: 99999
shadowWarning: 7
loginShell: /sbin/nologin
uidNumber: 13
gidNumber: 30
homeDirectory: /var/gopher
gecos: gopher

<span style="color: #859900; font-weight: bold;">dn</span>: <span style="color: #268bd2;">uid=ftp,ou=People,dc=mercury,dc=febras,dc=net</span>
uid: ftp
cn: FTP User
objectClass: account
objectClass: posixAccount
objectClass: top
objectClass: shadowAccount
userPassword: {crypt}*
shadowLastChange: 17191
shadowMin: 0
shadowMax: 99999
shadowWarning: 7
loginShell: /sbin/nologin
uidNumber: 14
gidNumber: 50
homeDirectory: /var/ftp
gecos: FTP User

<span style="color: #859900; font-weight: bold;">dn</span>: <span style="color: #268bd2;">uid=nobody,ou=People,dc=mercury,dc=febras,dc=net</span>
uid: nobody
cn: Nobody
objectClass: account
objectClass: posixAccount
objectClass: top
objectClass: shadowAccount
userPassword: {crypt}*
shadowLastChange: 17191
shadowMin: 0
shadowMax: 99999
shadowWarning: 7
loginShell: /sbin/nologin
uidNumber: 99
gidNumber: 99
homeDirectory: /
gecos: Nobody

<span style="color: #859900; font-weight: bold;">dn</span>: <span style="color: #268bd2;">uid=vcsa,ou=People,dc=mercury,dc=febras,dc=net</span>
uid: vcsa
cn: virtual console memory owner
objectClass: account
objectClass: posixAccount
objectClass: top
objectClass: shadowAccount
userPassword: {crypt}!!
shadowLastChange: 17191
shadowMin: 0
shadowMax: 99999
shadowWarning: 7
loginShell: /sbin/nologin
uidNumber: 69
gidNumber: 69
homeDirectory: /dev
gecos: virtual console memory owner

<span style="color: #859900; font-weight: bold;">dn</span>: <span style="color: #268bd2;">uid=nscd,ou=People,dc=mercury,dc=febras,dc=net</span>
uid: nscd
cn: NSCD Daemon
objectClass: account
objectClass: posixAccount
objectClass: top
objectClass: shadowAccount
userPassword: {crypt}!!
shadowLastChange: 17191
shadowMin: 0
shadowMax: 99999
shadowWarning: 7
loginShell: /sbin/nologin
uidNumber: 28
gidNumber: 28
homeDirectory: /
gecos: NSCD Daemon

<span style="color: #859900; font-weight: bold;">dn</span>: <span style="color: #268bd2;">uid=sshd,ou=People,dc=mercury,dc=febras,dc=net</span>
uid: sshd
cn: Privilege-separated SSH
objectClass: account
objectClass: posixAccount
objectClass: top
objectClass: shadowAccount
userPassword: {crypt}!!
shadowLastChange: 17191
shadowMin: 0
shadowMax: 99999
shadowWarning: 7
loginShell: /sbin/nologin
uidNumber: 74
gidNumber: 74
homeDirectory: /var/empty/sshd
gecos: Privilege-separated SSH

<span style="color: #859900; font-weight: bold;">dn</span>: <span style="color: #268bd2;">uid=ldap,ou=People,dc=mercury,dc=febras,dc=net</span>
uid: ldap
cn: LDAP User
objectClass: account
objectClass: posixAccount
objectClass: top
objectClass: shadowAccount
userPassword: {crypt}!!
shadowLastChange: 17191
shadowMin: 0
shadowMax: 99999
shadowWarning: 7
loginShell: /bin/false
uidNumber: 55
gidNumber: 55
homeDirectory: /var/lib/ldap
gecos: LDAP User

<span style="color: #859900; font-weight: bold;">dn</span>: <span style="color: #268bd2;">uid=mailnull,ou=People,dc=mercury,dc=febras,dc=net</span>
uid: mailnull
cn: mailnull
objectClass: account
objectClass: posixAccount
objectClass: top
objectClass: shadowAccount
userPassword: {crypt}!!
shadowLastChange: 17191
shadowMin: 0
shadowMax: 99999
shadowWarning: 7
loginShell: /sbin/nologin
uidNumber: 47
gidNumber: 47
homeDirectory: /var/spool/mqueue

<span style="color: #859900; font-weight: bold;">dn</span>: <span style="color: #268bd2;">uid=smmsp,ou=People,dc=mercury,dc=febras,dc=net</span>
uid: smmsp
cn: smmsp
objectClass: account
objectClass: posixAccount
objectClass: top
objectClass: shadowAccount
userPassword: {crypt}!!
shadowLastChange: 17191
shadowMin: 0
shadowMax: 99999
shadowWarning: 7
loginShell: /sbin/nologin
uidNumber: 51
gidNumber: 51
homeDirectory: /var/spool/mqueue
</pre>
</div>
</div>

<br/><a onclick="toggleDiv2('myContent-group',$(this));" class="fa fa-caret-right">group.ldif</a>

<div id="myContent-group" style="display:none">
<div class="org-src-container">

<pre class="src src-ldif"><span style="color: #859900; font-weight: bold;">dn</span>: <span style="color: #268bd2;">cn=root,ou=Group,dc=mercury,dc=febras,dc=net</span>
objectClass: posixGroup
objectClass: top
cn: root
userPassword: {crypt}x
gidNumber: 0

<span style="color: #859900; font-weight: bold;">dn</span>: <span style="color: #268bd2;">cn=bin,ou=Group,dc=mercury,dc=febras,dc=net</span>
objectClass: posixGroup
objectClass: top
cn: bin
userPassword: {crypt}x
gidNumber: 1
memberUid: daemon
memberUid: root

<span style="color: #859900; font-weight: bold;">dn</span>: <span style="color: #268bd2;">cn=daemon,ou=Group,dc=mercury,dc=febras,dc=net</span>
objectClass: posixGroup
objectClass: top
cn: daemon
userPassword: {crypt}x
gidNumber: 2
memberUid: bin
memberUid: root

<span style="color: #859900; font-weight: bold;">dn</span>: <span style="color: #268bd2;">cn=sys,ou=Group,dc=mercury,dc=febras,dc=net</span>
objectClass: posixGroup
objectClass: top
cn: sys
userPassword: {crypt}x
gidNumber: 3
memberUid: adm
memberUid: bin
memberUid: root

<span style="color: #859900; font-weight: bold;">dn</span>: <span style="color: #268bd2;">cn=adm,ou=Group,dc=mercury,dc=febras,dc=net</span>
objectClass: posixGroup
objectClass: top
cn: adm
userPassword: {crypt}x
gidNumber: 4
memberUid: daemon
memberUid: root

<span style="color: #859900; font-weight: bold;">dn</span>: <span style="color: #268bd2;">cn=tty,ou=Group,dc=mercury,dc=febras,dc=net</span>
objectClass: posixGroup
objectClass: top
cn: tty
userPassword: {crypt}x
gidNumber: 5

<span style="color: #859900; font-weight: bold;">dn</span>: <span style="color: #268bd2;">cn=disk,ou=Group,dc=mercury,dc=febras,dc=net</span>
objectClass: posixGroup
objectClass: top
cn: disk
userPassword: {crypt}x
gidNumber: 6
memberUid: root

<span style="color: #859900; font-weight: bold;">dn</span>: <span style="color: #268bd2;">cn=lp,ou=Group,dc=mercury,dc=febras,dc=net</span>
objectClass: posixGroup
objectClass: top
cn: lp
userPassword: {crypt}x
gidNumber: 7
memberUid: daemon

<span style="color: #859900; font-weight: bold;">dn</span>: <span style="color: #268bd2;">cn=mem,ou=Group,dc=mercury,dc=febras,dc=net</span>
objectClass: posixGroup
objectClass: top
cn: mem
userPassword: {crypt}x
gidNumber: 8

<span style="color: #859900; font-weight: bold;">dn</span>: <span style="color: #268bd2;">cn=kmem,ou=Group,dc=mercury,dc=febras,dc=net</span>
objectClass: posixGroup
objectClass: top
cn: kmem
userPassword: {crypt}x
gidNumber: 9

<span style="color: #859900; font-weight: bold;">dn</span>: <span style="color: #268bd2;">cn=wheel,ou=Group,dc=mercury,dc=febras,dc=net</span>
objectClass: posixGroup
objectClass: top
cn: wheel
userPassword: {crypt}x
gidNumber: 10
memberUid: root

<span style="color: #859900; font-weight: bold;">dn</span>: <span style="color: #268bd2;">cn=mail,ou=Group,dc=mercury,dc=febras,dc=net</span>
objectClass: posixGroup
objectClass: top
cn: mail
userPassword: {crypt}x
gidNumber: 12

<span style="color: #859900; font-weight: bold;">dn</span>: <span style="color: #268bd2;">cn=news,ou=Group,dc=mercury,dc=febras,dc=net</span>
objectClass: posixGroup
objectClass: top
cn: news
userPassword: {crypt}x
gidNumber: 13

<span style="color: #859900; font-weight: bold;">dn</span>: <span style="color: #268bd2;">cn=uucp,ou=Group,dc=mercury,dc=febras,dc=net</span>
objectClass: posixGroup
objectClass: top
cn: uucp
userPassword: {crypt}x
gidNumber: 14

<span style="color: #859900; font-weight: bold;">dn</span>: <span style="color: #268bd2;">cn=man,ou=Group,dc=mercury,dc=febras,dc=net</span>
objectClass: posixGroup
objectClass: top
cn: man
userPassword: {crypt}x
gidNumber: 15

<span style="color: #859900; font-weight: bold;">dn</span>: <span style="color: #268bd2;">cn=games,ou=Group,dc=mercury,dc=febras,dc=net</span>
objectClass: posixGroup
objectClass: top
cn: games
userPassword: {crypt}x
gidNumber: 20

<span style="color: #859900; font-weight: bold;">dn</span>: <span style="color: #268bd2;">cn=gopher,ou=Group,dc=mercury,dc=febras,dc=net</span>
objectClass: posixGroup
objectClass: top
cn: gopher
userPassword: {crypt}x
gidNumber: 30

<span style="color: #859900; font-weight: bold;">dn</span>: <span style="color: #268bd2;">cn=dip,ou=Group,dc=mercury,dc=febras,dc=net</span>
objectClass: posixGroup
objectClass: top
cn: dip
userPassword: {crypt}x
gidNumber: 40

<span style="color: #859900; font-weight: bold;">dn</span>: <span style="color: #268bd2;">cn=ftp,ou=Group,dc=mercury,dc=febras,dc=net</span>
objectClass: posixGroup
objectClass: top
cn: ftp
userPassword: {crypt}x
gidNumber: 50

<span style="color: #859900; font-weight: bold;">dn</span>: <span style="color: #268bd2;">cn=lock,ou=Group,dc=mercury,dc=febras,dc=net</span>
objectClass: posixGroup
objectClass: top
cn: lock
userPassword: {crypt}x
gidNumber: 54

<span style="color: #859900; font-weight: bold;">dn</span>: <span style="color: #268bd2;">cn=nobody,ou=Group,dc=mercury,dc=febras,dc=net</span>
objectClass: posixGroup
objectClass: top
cn: nobody
userPassword: {crypt}x
gidNumber: 99

<span style="color: #859900; font-weight: bold;">dn</span>: <span style="color: #268bd2;">cn=users,ou=Group,dc=mercury,dc=febras,dc=net</span>
objectClass: posixGroup
objectClass: top
cn: users
userPassword: {crypt}x
gidNumber: 100

<span style="color: #859900; font-weight: bold;">dn</span>: <span style="color: #268bd2;">cn=floppy,ou=Group,dc=mercury,dc=febras,dc=net</span>
objectClass: posixGroup
objectClass: top
cn: floppy
userPassword: {crypt}x
gidNumber: 19

<span style="color: #859900; font-weight: bold;">dn</span>: <span style="color: #268bd2;">cn=vcsa,ou=Group,dc=mercury,dc=febras,dc=net</span>
objectClass: posixGroup
objectClass: top
cn: vcsa
userPassword: {crypt}x
gidNumber: 69

<span style="color: #859900; font-weight: bold;">dn</span>: <span style="color: #268bd2;">cn=audio,ou=Group,dc=mercury,dc=febras,dc=net</span>
objectClass: posixGroup
objectClass: top
cn: audio
userPassword: {crypt}x
gidNumber: 63

<span style="color: #859900; font-weight: bold;">dn</span>: <span style="color: #268bd2;">cn=utmp,ou=Group,dc=mercury,dc=febras,dc=net</span>
objectClass: posixGroup
objectClass: top
cn: utmp
userPassword: {crypt}x
gidNumber: 22

<span style="color: #859900; font-weight: bold;">dn</span>: <span style="color: #268bd2;">cn=nscd,ou=Group,dc=mercury,dc=febras,dc=net</span>
objectClass: posixGroup
objectClass: top
cn: nscd
userPassword: {crypt}x
gidNumber: 28

<span style="color: #859900; font-weight: bold;">dn</span>: <span style="color: #268bd2;">cn=sshd,ou=Group,dc=mercury,dc=febras,dc=net</span>
objectClass: posixGroup
objectClass: top
cn: sshd
userPassword: {crypt}x
gidNumber: 74

<span style="color: #859900; font-weight: bold;">dn</span>: <span style="color: #268bd2;">cn=ldap,ou=Group,dc=mercury,dc=febras,dc=net</span>
objectClass: posixGroup
objectClass: top
cn: ldap
userPassword: {crypt}x
gidNumber: 55

<span style="color: #859900; font-weight: bold;">dn</span>: <span style="color: #268bd2;">cn=mailnull,ou=Group,dc=mercury,dc=febras,dc=net</span>
objectClass: posixGroup
objectClass: top
cn: mailnull
userPassword: {crypt}x
gidNumber: 47

<span style="color: #859900; font-weight: bold;">dn</span>: <span style="color: #268bd2;">cn=smmsp,ou=Group,dc=mercury,dc=febras,dc=net</span>
objectClass: posixGroup
objectClass: top
cn: smmsp
userPassword: {crypt}x
gidNumber: 51
</pre>
</div>
</div>
</div>
</div>
</div>

<div id="outline-container-orgheadline31" class="outline-2">
<h2 id="cluster"><a id="orgheadline31"></a><a id="ID-db5bc4cf-74c3-40e0-b8b3-d57f3f32e338"></a><span class="section-number-2">5</span> Перевести аутентификацию пользователей кластера на использование LDAP</h2>
<div class="outline-text-2" id="text-cluster">
</div>
</div>
<div id="footnotes">
<h2 class="footnotes">&#1057;&#1085;&#1086;&#1089;&#1082;&#1080;: </h2>
<div id="text-footnotes">

<div class="footdef"><sup><a id="fn.1" class="footnum" href="#fnr.1">1</a></sup> <div class="footpara"><a href="https://github.com/boykov/cc-ldap-centos">https://github.com/boykov/cc-ldap-centos</a></div></div>

<div class="footdef"><sup><a id="fn.2" class="footnum" href="#fnr.2">2</a></sup> <div class="footpara"><a href="http://pro-ldap.ru/tr/admin24/quickstart.html">http://pro-ldap.ru/tr/admin24/quickstart.html</a></div></div>

<div class="footdef"><sup><a id="fn.3" class="footnum" href="#fnr.3">3</a></sup> <div class="footpara"><a href="http://pro-ldap.ru/tr/admin24/slapdconf2.html#Converting%20old%20style%20slapd.conf%20file%20to%20cn=config%20format">http://pro-ldap.ru/tr/admin24/slapdconf2.html#Converting%20old%20style%20slapd.conf%20file%20to%20cn=config%20format</a></div></div>

<div class="footdef"><sup><a id="fn.4" class="footnum" href="#fnr.4">4</a></sup> <div class="footpara"><a href="https://github.com/boykov/cc-ldap-centos/blob/master/ldap-server/2.5-schema-ldif.sh">https://github.com/boykov/cc-ldap-centos/blob/master/ldap-server/2.5-schema-ldif.sh</a></div></div>

<div class="footdef"><sup><a id="fn.5" class="footnum" href="#fnr.5">5</a></sup> <div class="footpara"><a href="http://www.intuit.ru/studies/courses/73/73/lecture/2202?page=2">http://www.intuit.ru/studies/courses/73/73/lecture/2202?page=2</a></div></div>

<div class="footdef"><sup><a id="fn.6" class="footnum" href="#fnr.6">6</a></sup> <div class="footpara"><a href="http://pro-ldap.ru/books/openldap-ubuntu-in-practice/index.html">http://pro-ldap.ru/books/openldap-ubuntu-in-practice/index.html</a></div></div>

<div class="footdef"><sup><a id="fn.7" class="footnum" href="#fnr.7">7</a></sup> <div class="footpara"><a href="https://www.fusiondirectory.org/user_management/">https://www.fusiondirectory.org/user_management/</a></div></div>


</div>
</div></div>
</body>
</html>
